REDACTOR={version:"10.2.5",instances:{},params:{}};(function($){'use strict';if(!Function.prototype.bind){Function.prototype.bind=function(a){var b=this;return function(){return b.apply(a)}}}var A=0;$.fn.redactor=function(d){var e=[];var f=Array.prototype.slice.call(arguments,1);if(typeof d==='string'){this.each(function(){var a=$.data(this,'redactor');var b;if(d.search(/\./)!='-1'){b=d.split('.');if(typeof a[b[0]]!='undefined'){b=a[b[0]][b[1]]}}else{b=a[d]}if(typeof a!=='undefined'&&$.isFunction(b)){var c=b.apply(a,f);if(c!==undefined&&c!==a){e.push(c)}}else{$.error('No such method "'+d+'" for Redactor')}})}else{this.each(function(){$.data(this,'redactor',{});$.data(this,'redactor',Redactor(this,d))})}if(e.length===0)return this;else if(e.length===1)return e[0];else return e};function Redactor(a,b){return new Redactor.prototype.init(a,b)}$.Redactor=Redactor;$.Redactor.VERSION='10.2.5';$.Redactor.modules=['alignment','autosave','block','buffer','build','button','caret','clean','code','core','dropdown','file','focus','image','indent','inline','insert','keydown','keyup','lang','line','link','linkify','list','modal','observe','paragraphize','paste','placeholder','progress','selection','shortcuts','tabifier','tidy','toolbar','upload','utils'];$.Redactor.opts={lang:'en',direction:'ltr',plugins:false,focus:false,focusEnd:false,placeholder:false,visual:true,tabindex:false,minHeight:false,maxHeight:false,linebreaks:false,replaceDivs:true,paragraphize:true,cleanStyleOnEnter:false,enterKey:true,cleanOnPaste:true,cleanSpaces:true,pastePlainText:false,autosave:false,autosaveName:false,autosaveInterval:60,autosaveOnChange:false,autosaveFields:false,linkTooltip:true,linkProtocol:'http',linkNofollow:false,linkSize:50,imageEditable:true,imageLink:true,imagePosition:true,imageFloatMargin:'10px',imageResizable:true,imageUpload:null,imageUploadParam:'file',uploadImageField:false,dragImageUpload:true,fileUpload:null,fileUploadParam:'file',dragFileUpload:true,s3:false,convertLinks:true,convertUrlLinks:true,convertImageLinks:true,convertVideoLinks:true,preSpaces:4,tabAsSpaces:false,tabKey:true,scrollTarget:false,toolbar:true,toolbarFixed:true,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:false,toolbarOverflow:false,source:true,buttons:['html','formatting','bold','italic','deleted','unorderedlist','orderedlist','outdent','indent','image','file','link','alignment','horizontalrule'],buttonsHide:[],buttonsHideOnMobile:[],formatting:['p','blockquote','pre','h1','h2','h3','h4','h5','h6'],formattingAdd:false,tabifier:true,deniedTags:['script','style'],allowedTags:false,paragraphizeBlocks:['table','div','pre','form','ul','ol','h1','h2','h3','h4','h5','h6','dl','blockquote','figcaption','address','section','header','footer','aside','article','object','style','script','iframe','select','input','textarea','button','option','map','area','math','hr','fieldset','legend','hgroup','nav','figure','details','menu','summary','p'],removeComments:false,replaceTags:[['strike','del'],['b','strong']],replaceStyles:[['font-weight:\\s?bold',"strong"],['font-style:\\s?italic',"em"],['text-decoration:\\s?underline',"u"],['text-decoration:\\s?line-through','del']],removeDataAttr:false,removeAttr:false,allowedAttr:false,removeWithoutAttr:['span'],removeEmpty:['p'],activeButtons:['deleted','italic','bold','underline','unorderedlist','orderedlist','alignleft','aligncenter','alignright','justify'],activeButtonsStates:{b:'bold',strong:'bold',i:'italic',em:'italic',del:'deleted',strike:'deleted',ul:'unorderedlist',ol:'orderedlist',u:'underline'},shortcuts:{'ctrl+shift+m, meta+shift+m':{func:'inline.removeFormat'},'ctrl+b, meta+b':{func:'inline.format',params:['bold']},'ctrl+i, meta+i':{func:'inline.format',params:['italic']},'ctrl+h, meta+h':{func:'inline.format',params:['superscript']},'ctrl+l, meta+l':{func:'inline.format',params:['subscript']},'ctrl+k, meta+k':{func:'link.show'},'ctrl+shift+7':{func:'list.toggle',params:['orderedlist']},'ctrl+shift+8':{func:'list.toggle',params:['unorderedlist']}},shortcutsAdd:false,buffer:[],rebuffer:[],emptyHtml:'<p>&#x200b;</p>',invisibleSpace:'&#x200b;',imageTypes:['image/png','image/jpeg','image/gif'],indentValue:20,verifiedTags:['a','img','b','strong','sub','sup','i','em','u','small','strike','del','cite','ul','ol','li'],inlineTags:['strong','b','u','em','i','code','del','ins','samp','kbd','sup','sub','mark','var','cite','small'],alignmentTags:['P','H1','H2','H3','H4','H5','H6','DL','DT','DD','DIV','TD','BLOCKQUOTE','OUTPUT','FIGCAPTION','ADDRESS','SECTION','HEADER','FOOTER','ASIDE','ARTICLE'],blockLevelElements:['PRE','UL','OL','LI'],highContrast:false,observe:{dropdowns:[]},langs:{en:{html:'HTML',video:'Insert Video',image:'Insert Image',table:'Table',link:'Link',link_insert:'Insert link',link_edit:'Edit link',unlink:'Unlink',formatting:'Formatting',paragraph:'Normal text',quote:'Quote',code:'Code',header1:'Header 1',header2:'Header 2',header3:'Header 3',header4:'Header 4',header5:'Header 5',bold:'Bold',italic:'Italic',fontcolor:'Font Color',backcolor:'Back Color',unorderedlist:'Unordered List',orderedlist:'Ordered List',outdent:'Outdent',indent:'Indent',cancel:'Cancel',insert:'Insert',save:'Save',_delete:'Delete',insert_table:'Insert Table',insert_row_above:'Add Row Above',insert_row_below:'Add Row Below',insert_column_left:'Add Column Left',insert_column_right:'Add Column Right',delete_column:'Delete Column',delete_row:'Delete Row',delete_table:'Delete Table',rows:'Rows',columns:'Columns',add_head:'Add Head',delete_head:'Delete Head',title:'Title',image_position:'Position',none:'None',left:'Left',right:'Right',center:'Center',image_web_link:'Image Web Link',text:'Text',mailto:'Email',web:'URL',video_html_code:'Video Embed Code or Youtube/Vimeo Link',file:'Insert File',upload:'Upload',download:'Download',choose:'Choose',or_choose:'Or choose',drop_file_here:'Drop file here',align_left:'Align text to the left',align_center:'Center text',align_right:'Align text to the right',align_justify:'Justify text',horizontalrule:'Insert Horizontal Rule',deleted:'Deleted',anchor:'Anchor',link_new_tab:'Open link in new tab',underline:'Underline',alignment:'Alignment',filename:'Name (optional)',edit:'Edit',upload_label:'Drop file here or '}},linkify:{regexps:{youtube:/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.\-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig,vimeo:/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/,image:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/ig,url:/(https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,})/ig,}},codemirror:false};Redactor.fn=$.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37,LEFT_WIN:91},init:function(a,b){this.$element=$(a);this.uuid=A++;this.rtePaste=false;this.$pasteBox=false;this.loadOptions(b);this.loadModules();this.formatting={};$.merge(this.opts.blockLevelElements,this.opts.alignmentTags);this.reIsBlock=new RegExp('^('+this.opts.blockLevelElements.join('|')+')$','i');this.tidy.setupAllowed();if(this.opts.deniedTags!==false){var c=['html','head','link','body','meta','applet'];for(var i=0;i<c.length;i++){this.opts.deniedTags.push(c[i])}}this.lang.load();$.extend(this.opts.shortcuts,this.opts.shortcutsAdd);this.core.setCallback('start');this.start=true;this.build.run()},loadOptions:function(a){this.opts=$.extend({},$.extend(true,{},$.Redactor.opts),this.$element.data(),a)},getModuleMethods:function(b){return Object.getOwnPropertyNames(b).filter(function(a){return typeof b[a]=='function'})},loadModules:function(){var a=$.Redactor.modules.length;for(var i=0;i<a;i++){this.bindModuleMethods($.Redactor.modules[i])}},bindModuleMethods:function(a){if(typeof this[a]=='undefined')return;this[a]=this[a]();var b=this.getModuleMethods(this[a]);var c=b.length;for(var z=0;z<c;z++){this[a][b[z]]=this[a][b[z]].bind(this)}},alignment:function(){return{left:function(){this.alignment.set('')},right:function(){this.alignment.set('right')},center:function(){this.alignment.set('center')},justify:function(){this.alignment.set('justify')},set:function(a){if(!this.utils.browser('msie')&&!this.opts.linebreaks){this.$editor.focus()}this.alignment.blocks=this.selection.getBlocks();this.alignment.type=a;this.buffer.set();this.selection.save();if(this.alignment.isLinebreaksOrNoBlocks()){this.alignment.setText()}else{this.alignment.setBlocks()}this.selection.restore();this.code.sync()},setText:function(){var a=this.selection.wrap('div');$(a).attr('data-tagblock','redactor').css('text-align',this.alignment.type)},setBlocks:function(){$.each(this.alignment.blocks,$.proxy(function(i,a){var b=this.utils.getAlignmentElement(a);if(!b)return;if(this.alignment.isNeedReplaceElement(b)){this.alignment.replaceElement(b)}else{this.alignment.alignElement(b)}},this))},isLinebreaksOrNoBlocks:function(){return(this.opts.linebreaks&&this.alignment.blocks[0]===false)},isNeedReplaceElement:function(a){return(this.alignment.type===''&&typeof(a.data('tagblock'))!=='undefined')},replaceElement:function(a){a.replaceWith(a.html())},alignElement:function(a){a.css('text-align',this.alignment.type);this.utils.removeEmptyAttr(a,'style')}}},autosave:function(){return{html:false,enable:function(){if(!this.opts.autosave)return;this.autosave.name=(this.opts.autosaveName)?this.opts.autosaveName:this.$textarea.attr('name');if(this.opts.autosaveOnChange)return;this.autosaveInterval=setInterval(this.autosave.load,this.opts.autosaveInterval*1000)},onChange:function(){if(!this.opts.autosaveOnChange)return;this.autosave.load()},load:function(){if(!this.opts.autosave)return;this.autosave.source=this.code.get();if(this.autosave.html===this.autosave.source)return;var a={};a['name']=this.autosave.name;a[this.autosave.name]=this.autosave.source;a=this.autosave.getHiddenFields(a);var b=$.ajax({url:this.opts.autosave,type:'post',data:a});b.done(this.autosave.success)},getHiddenFields:function(a){if(this.opts.autosaveFields===false||typeof this.opts.autosaveFields!=='object'){return a}$.each(this.opts.autosaveFields,$.proxy(function(k,v){if(v!==null&&v.toString().indexOf('#')===0)v=$(v).val();a[k]=v},this));return a},success:function(a){var b;try{b=$.parseJSON(a)}catch(e){b=a}var c=(typeof b.error=='undefined')?'autosave':'autosaveError';this.core.setCallback(c,this.autosave.name,b);this.autosave.html=this.autosave.source},disable:function(){clearInterval(this.autosaveInterval)}}},block:function(){return{formatting:function(a){this.block.clearStyle=false;var b,value;if(typeof this.formatting[a].data!='undefined')b='data';else if(typeof this.formatting[a].attr!='undefined')b='attr';else if(typeof this.formatting[a]['class']!='undefined')b='class';if(typeof this.formatting[a].clear!='undefined'){this.block.clearStyle=true}if(b)value=this.formatting[a][b];this.block.format(this.formatting[a].tag,b,value)},format:function(a,b,c){if(a=='quote')a='blockquote';var d=['p','pre','blockquote','h1','h2','h3','h4','h5','h6'];if($.inArray(a,d)==-1)return;this.block.isRemoveInline=(a=='pre'||a.search(/h[1-6]/i)!=-1);if(!this.utils.browser('msie'))this.$editor.focus();var e=$.trim(this.$editor.html());this.block.isEmpty=this.utils.isEmpty(e);if(this.utils.browser('mozilla')&&!this.focus.isFocused()){if(this.block.isEmpty){var f;if(!this.opts.linebreaks){f=this.$editor.children().first();this.caret.setEnd(f)}}}this.block.blocks=this.selection.getBlocks();this.block.blocksSize=this.block.blocks.length;this.block.type=b;this.block.value=c;this.buffer.set();this.selection.save();this.block.set(a);this.selection.restore();this.code.sync();this.observe.load()},set:function(a){this.selection.get();this.block.containerTag=this.range.commonAncestorContainer.tagName;if(this.range.collapsed){this.block.setCollapsed(a)}else{this.block.setMultiple(a)}},setCollapsed:function(a){if(this.opts.linebreaks&&this.block.isEmpty&&a!='p'){var b=document.createElement(a);this.$editor.html(b);this.caret.setEnd(b);return}var c=this.block.blocks[0];if(c===false)return;if(c.tagName=='LI'){if(a!='blockquote')return;this.block.formatListToBlockquote();return}var d=(this.block.containerTag=='TD'||this.block.containerTag=='TH');if(d&&!this.opts.linebreaks){document.execCommand('formatblock',false,'<'+a+'>');c=this.selection.getBlock();this.block.toggle($(c))}else if(c.tagName.toLowerCase()!=a){if(this.opts.linebreaks&&a=='p'){$(c).append('<br>');this.utils.replaceWithContents(c)}else{var e=this.utils.replaceToTag(c,a);this.block.toggle(e);if(a!='p'&&a!='blockquote')e.find('img').remove();if(this.block.isRemoveInline)this.utils.removeInlineTags(e);if(a=='p'||this.block.headTag)e.find('p').contents().unwrap();this.block.formatTableWrapping(e)}}else if(a=='blockquote'&&c.tagName.toLowerCase()==a){if(this.opts.linebreaks){$(c).append('<br>');this.utils.replaceWithContents(c)}else{var f=this.utils.replaceToTag(c,'p');this.block.toggle(f)}}else if(c.tagName.toLowerCase()==a){this.block.toggle($(c))}if(typeof this.block.type=='undefined'&&typeof this.block.value=='undefined'){$(c).removeAttr('class').removeAttr('style')}},setMultiple:function(b){var c=this.block.blocks[0];var d=(this.block.containerTag=='TD'||this.block.containerTag=='TH');if(c!==false&&this.block.blocksSize===1){if(c.tagName.toLowerCase()==b&&b=='blockquote'){if(this.opts.linebreaks){$(c).append('<br>');this.utils.replaceWithContents(c)}else{var e=this.utils.replaceToTag(c,'p');this.block.toggle(e)}}else if(c.tagName=='LI'){if(b!='blockquote')return;this.block.formatListToBlockquote()}else if(this.block.containerTag=='BLOCKQUOTE'){this.block.formatBlockquote(b)}else if(this.opts.linebreaks&&((d)||(this.range.commonAncestorContainer!=c))){this.block.formatWrap(b)}else{if(this.opts.linebreaks&&b=='p'){$(c).prepend('<br>').append('<br>');this.utils.replaceWithContents(c)}else if(c.tagName==='TD'){this.block.formatWrap(b)}else{var f=this.utils.replaceToTag(c,b);this.block.toggle(f);if(this.block.isRemoveInline)this.utils.removeInlineTags(f);if(b=='p'||this.block.headTag)f.find('p').contents().unwrap()}}}else{if(this.opts.linebreaks||b!='p'){if(b=='blockquote'){var g=0;for(var i=0;i<this.block.blocksSize;i++){if(this.block.blocks[i].tagName=='BLOCKQUOTE')g++}if(g==this.block.blocksSize){$.each(this.block.blocks,$.proxy(function(i,s){var a=false;if(this.opts.linebreaks){$(s).prepend('<br>').append('<br>');a=this.utils.replaceWithContents(s)}else{a=this.utils.replaceToTag(s,'p')}if(a&&typeof this.block.type=='undefined'&&typeof this.block.value=='undefined'){a.removeAttr('class').removeAttr('style')}},this));return}}this.block.formatWrap(b)}else{var h=0;var j=false;if(this.block.type=='class'){j='toggle';h=$(this.block.blocks).filter('.'+this.block.value).length;if(this.block.blocksSize==h)j='toggle';else if(this.block.blocksSize>h)j='set';else if(h===0)j='set'}var k=['ul','ol','li','td','th','dl','dt','dd'];$.each(this.block.blocks,$.proxy(function(i,s){if($.inArray(s.tagName.toLowerCase(),k)!=-1)return;var a=this.utils.replaceToTag(s,b);if(j){if(j=='toggle')this.block.toggle(a);else if(j=='remove')this.block.remove(a);else if(j=='set')this.block.setForce(a)}else this.block.toggle(a);if(b!='p'&&b!='blockquote')a.find('img').remove();if(this.block.isRemoveInline)this.utils.removeInlineTags(a);if(b=='p'||this.block.headTag)a.find('p').contents().unwrap();if(typeof this.block.type=='undefined'&&typeof this.block.value=='undefined'){a.removeAttr('class').removeAttr('style')}},this))}}},setForce:function(a){if(this.block.clearStyle){a.removeAttr('class').removeAttr('style')}if(this.block.type=='class'){a.addClass(this.block.value);return}else if(this.block.type=='attr'||this.block.type=='data'){a.attr(this.block.value.name,this.block.value.value);return}},toggle:function(a){if(this.block.clearStyle){a.removeAttr('class').removeAttr('style')}if(this.block.type=='class'){a.toggleClass(this.block.value);return}else if(this.block.type=='attr'||this.block.type=='data'){if(a.attr(this.block.value.name)==this.block.value.value){a.removeAttr(this.block.value.name)}else{a.attr(this.block.value.name,this.block.value.value)}return}else{a.removeAttr('style class');return}},remove:function(a){a.removeClass(this.block.value)},formatListToBlockquote:function(){var a=$(this.block.blocks[0]).closest('ul, ol',this.$editor[0]);$(a).find('ul, ol').contents().unwrap();$(a).find('li').append($('<br>')).contents().unwrap();var b=this.utils.replaceToTag(a,'blockquote');this.block.toggle(b)},formatBlockquote:function(a){document.execCommand('outdent');document.execCommand('formatblock',false,a);this.clean.clearUnverified();this.$editor.find('p:empty').remove();var b=this.selection.getBlock();if(a!='p'){$(b).find('img').remove()}if(!this.opts.linebreaks){this.block.toggle($(b))}this.$editor.find('ul, ol, tr, blockquote, p').each($.proxy(this.utils.removeEmpty,this));if(this.opts.linebreaks&&a=='p'){this.utils.replaceWithContents(b)}},formatWrap:function(a){if(this.block.containerTag=='UL'||this.block.containerTag=='OL'){if(a=='blockquote'){this.block.formatListToBlockquote()}else{return}}var b=this.selection.wrap(a);if(b===false)return;var c=$(b);this.block.formatTableWrapping(c);var d=c.find(this.opts.blockLevelElements.join(',')+', td, table, thead, tbody, tfoot, th, tr');d.contents().unwrap();if(a!='p'&&a!='blockquote')c.find('img').remove();$.each(this.block.blocks,$.proxy(this.utils.removeEmpty,this));c.append(this.selection.getMarker(2));if(!this.opts.linebreaks){this.block.toggle(c)}this.$editor.find('ul, ol, tr, blockquote, p').each($.proxy(this.utils.removeEmpty,this));c.find('blockquote:empty').remove();if(this.block.isRemoveInline){this.utils.removeInlineTags(c)}if(this.opts.linebreaks&&a=='p'){this.utils.replaceWithContents(c)}if(this.opts.linebreaks){var e=c.next().next();if(e.size()!=0&&e[0].tagName==='BR'){e.remove()}}},formatTableWrapping:function(a){if(a.closest('table',this.$editor[0]).length===0)return;if(a.closest('tr',this.$editor[0]).length===0)a.wrap('<tr>');if(a.closest('td',this.$editor[0]).length===0&&a.closest('th').length===0){a.wrap('<td>')}},removeData:function(a,b){var c=this.selection.getBlocks();$(c).removeAttr('data-'+a);this.code.sync()},setData:function(a,b){var c=this.selection.getBlocks();$(c).attr('data-'+a,b);this.code.sync()},toggleData:function(a,b){var c=this.selection.getBlocks();$.each(c,function(){if($(this).attr('data-'+a)){$(this).removeAttr('data-'+a)}else{$(this).attr('data-'+a,b)}})},removeAttr:function(a,b){var c=this.selection.getBlocks();$(c).removeAttr(a);this.code.sync()},setAttr:function(a,b){var c=this.selection.getBlocks();$(c).attr(a,b);this.code.sync()},toggleAttr:function(a,b){var c=this.selection.getBlocks();$.each(c,function(){if($(this).attr(name)){$(this).removeAttr(name)}else{$(this).attr(name,b)}})},removeClass:function(a){var b=this.selection.getBlocks();$(b).removeClass(a);this.utils.removeEmptyAttr(b,'class');this.code.sync()},setClass:function(a){var b=this.selection.getBlocks();$(b).addClass(a);this.code.sync()},toggleClass:function(a){var b=this.selection.getBlocks();$(b).toggleClass(a);this.code.sync()}}},buffer:function(){return{set:function(a){if(typeof a=='undefined'||a=='undo'){this.buffer.setUndo()}else{this.buffer.setRedo()}},setUndo:function(){this.selection.save();this.opts.buffer.push(this.$editor.html());this.selection.restore()},setRedo:function(){this.selection.save();this.opts.rebuffer.push(this.$editor.html());this.selection.restore()},getUndo:function(){this.$editor.html(this.opts.buffer.pop())},getRedo:function(){this.$editor.html(this.opts.rebuffer.pop())},add:function(){this.opts.buffer.push(this.$editor.html())},undo:function(){if(this.opts.buffer.length===0)return;this.buffer.set('redo');this.buffer.getUndo();this.selection.restore();setTimeout($.proxy(this.observe.load,this),50)},redo:function(){if(this.opts.rebuffer.length===0)return;this.buffer.set('undo');this.buffer.getRedo();this.selection.restore();setTimeout($.proxy(this.observe.load,this),50)}}},build:function(){return{focused:false,blured:true,run:function(){this.build.createContainerBox();this.build.loadContent();this.build.loadEditor();this.build.enableEditor();this.build.setCodeAndCall()},isTextarea:function(){return(this.$element[0].tagName==='TEXTAREA')},createContainerBox:function(){this.$box=$('<div class="redactor-box" role="application" />')},createTextarea:function(){this.$textarea=$('<textarea />').attr('name',this.build.getTextareaName())},getTextareaName:function(){return((typeof(name)=='undefined'))?'content-'+this.uuid:this.$element.attr('id')},loadContent:function(){var a=(this.build.isTextarea())?'val':'html';this.content=$.trim(this.$element[a]())},enableEditor:function(){this.$editor.attr({'contenteditable':true,'dir':this.opts.direction})},loadEditor:function(){var a=(this.build.isTextarea())?'fromTextarea':'fromElement';this.build[a]()},fromTextarea:function(){this.$editor=$('<div />');this.$textarea=this.$element;this.$box.insertAfter(this.$element).append(this.$editor).append(this.$element);this.$editor.addClass('redactor-editor');this.$element.hide()},fromElement:function(){this.$editor=this.$element;this.build.createTextarea();this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$textarea);this.$editor.addClass('redactor-editor');this.$textarea.hide()},setCodeAndCall:function(){this.code.set(this.content);this.build.setOptions();this.build.callEditor();if(this.opts.visual)return;setTimeout($.proxy(this.code.showCode,this),200)},callEditor:function(){this.build.disableMozillaEditing();this.build.disableIeLinks();this.build.setEvents();this.build.setHelpers();if(this.opts.toolbar){this.opts.toolbar=this.toolbar.init();this.toolbar.build()}this.modal.loadTemplates();this.build.plugins();setTimeout($.proxy(this.observe.load,this),4);this.core.setCallback('init');this.focus.setEnd()},setOptions:function(){$(this.$textarea).attr('dir',this.opts.direction);if(this.opts.linebreaks)this.$editor.addClass('redactor-linebreaks');if(this.opts.tabindex)this.$editor.attr('tabindex',this.opts.tabindex);if(this.opts.minHeight)this.$editor.css('minHeight',this.opts.minHeight);if(this.opts.maxHeight)this.$editor.css('maxHeight',this.opts.maxHeight)},setEventDropUpload:function(e){e.preventDefault();if(!this.opts.dragImageUpload||!this.opts.dragFileUpload)return;var a=e.dataTransfer.files;this.upload.directUpload(a[0],e)},setEventDrop:function(e){this.code.sync();setTimeout(this.clean.clearUnverified,1);this.core.setCallback('drop',e)},setEvents:function(){this.$editor.on('dragover.redactor dragenter.redactor',function(e){e.preventDefault();e.stopPropagation()});this.$editor.on('drop.redactor',$.proxy(function(e){e=e.originalEvent||e;if(window.FormData===undefined||!e.dataTransfer)return true;if(e.dataTransfer.files.length===0){return this.build.setEventDrop(e)}else{this.build.setEventDropUpload(e)}setTimeout(this.clean.clearUnverified,1);this.core.setCallback('drop',e)},this));this.$editor.on('click.redactor',$.proxy(function(e){var a=this.core.getEvent();var b=(a=='click'||a=='arrow')?false:'click';this.core.addEvent(b);this.utils.disableSelectAll();this.core.setCallback('click',e)},this));this.$editor.on('paste.redactor',$.proxy(this.paste.init,this));this.$editor.on('cut.redactor',$.proxy(this.code.sync,this));this.$editor.on('keydown.redactor',$.proxy(this.keydown.init,this));this.$editor.on('keyup.redactor',$.proxy(this.keyup.init,this));if($.isFunction(this.opts.codeKeydownCallback)){this.$textarea.on('keydown.redactor-textarea',$.proxy(this.opts.codeKeydownCallback,this))}if($.isFunction(this.opts.codeKeyupCallback)){this.$textarea.on('keyup.redactor-textarea',$.proxy(this.opts.codeKeyupCallback,this))}this.$editor.on('focus.redactor',$.proxy(function(e){if($.isFunction(this.opts.focusCallback)){this.core.setCallback('focus',e)}this.build.focused=true;this.build.blured=false;if(this.selection.getCurrent()===false){this.selection.get();this.range.setStart(this.$editor[0],0);this.range.setEnd(this.$editor[0],0);this.selection.addRange()}},this));$(document).on('mousedown.redactor-blur.'+this.uuid,$.proxy(function(e){if(this.start)return;if(this.rtePaste)return;if($(e.target).closest('.redactor-editor, .redactor-toolbar, .redactor-dropdown').size()!==0){return}this.utils.disableSelectAll();if(!this.build.blured&&$.isFunction(this.opts.blurCallback)){this.core.setCallback('blur',e)}this.build.focused=false;this.build.blured=true},this))},setHelpers:function(){if(this.linkify.isEnabled()){this.linkify.format()}this.placeholder.enable();if(this.opts.focus)setTimeout(this.focus.setStart,100);if(this.opts.focusEnd)setTimeout(this.focus.setEnd,100)},plugins:function(){if(!this.opts.plugins)return;$.each(this.opts.plugins,$.proxy(function(i,s){var a=(typeof RedactorPlugins!=='undefined'&&typeof RedactorPlugins[s]!=='undefined')?RedactorPlugins:Redactor.fn;if(!$.isFunction(a[s])){return}this[s]=a[s]();var b=this.getModuleMethods(this[s]);var c=b.length;for(var z=0;z<c;z++){this[s][b[z]]=this[s][b[z]].bind(this)}if($.isFunction(this[s].init)){this[s].init()}},this))},disableMozillaEditing:function(){if(!this.utils.browser('mozilla'))return;try{document.execCommand('enableObjectResizing',false,false);document.execCommand('enableInlineTableEditing',false,false)}catch(e){}},disableIeLinks:function(){if(!this.utils.browser('msie'))return;document.execCommand("AutoUrlDetect",false,false)}}},button:function(){return{build:function(a,b){var c=$('<a href="#" class="re-icon re-'+a+'" rel="'+a+'" />').attr({'role':'button','aria-label':b.title,'tabindex':'-1'});if(b.func||b.command||b.dropdown){this.button.setEvent(c,a,b)}if(b.dropdown){c.addClass('redactor-toolbar-link-dropdown').attr('aria-haspopup',true);var d=$('<div class="redactor-dropdown redactor-dropdown-'+this.uuid+' redactor-dropdown-box-'+a+'" style="display: none;">');c.data('dropdown',d);this.dropdown.build(a,d,b.dropdown)}if(this.utils.isDesktop()){this.button.createTooltip(c,a,b.title)}return c},setEvent:function(c,d,f){c.on('touchstart click',$.proxy(function(e){if(c.hasClass('redactor-button-disabled'))return false;var a='func';var b=f.func;if(f.command){a='command';b=f.command}else if(f.dropdown){a='dropdown';b=false}this.button.onClick(e,d,a,b)},this))},createTooltip:function(b,c,d){var e=$('<span>').addClass('redactor-toolbar-tooltip redactor-toolbar-tooltip-'+this.uuid+' redactor-toolbar-tooltip-'+c).hide().html(d);e.appendTo('body');b.on('mouseover',function(){if($(this).hasClass('redactor-button-disabled')){return}var a=b.offset();e.css({top:(a.top+b.innerHeight())+'px',left:(a.left+b.innerWidth()/2-e.innerWidth()/2)+'px'});e.show()});b.on('mouseout',function(){e.hide()})},onClick:function(e,a,b,c){this.button.caretOffset=this.caret.getOffset();e.preventDefault();$(document).find('.redactor-toolbar-tooltip').hide();if(this.utils.browser('msie'))e.returnValue=false;if(b=='command')this.inline.format(c);else if(b=='dropdown')this.dropdown.show(e,a);else this.button.onClickCallback(e,c,a)},onClickCallback:function(e,a,b){var c;if($.isFunction(a))a.call(this,b);else if(a.search(/\./)!='-1'){c=a.split('.');if(typeof this[c[0]]=='undefined')return;this[c[0]][c[1]](b)}else this[a](b);this.observe.buttons(e,b)},get:function(a){return this.$toolbar.find('a.re-'+a)},setActive:function(a){this.button.get(a).addClass('redactor-act')},setInactive:function(a){this.button.get(a).removeClass('redactor-act')},setInactiveAll:function(a){if(typeof a==='undefined'){this.$toolbar.find('a.re-icon').removeClass('redactor-act')}else{this.$toolbar.find('a.re-icon').not('.re-'+a).removeClass('redactor-act')}},setActiveInVisual:function(){this.$toolbar.find('a.re-icon').not('a.re-html, a.re-fullscreen').removeClass('redactor-button-disabled')},setInactiveInCode:function(){this.$toolbar.find('a.re-icon').not('a.re-html, a.re-fullscreen').addClass('redactor-button-disabled')},changeIcon:function(a,b){this.button.get(a).addClass('re-'+b)},removeIcon:function(a,b){this.button.get(a).removeClass('re-'+b)},setAwesome:function(a,b){var c=this.button.get(a);c.removeClass('redactor-btn-image').addClass('fa-redactor-btn');c.html('<i class="fa '+b+'"></i>')},addCallback:function(a,b){if(a=="buffer")return;var c=(b=='dropdown')?'dropdown':'func';var d=a.attr('rel');a.on('touchstart click',$.proxy(function(e){if(a.hasClass('redactor-button-disabled'))return false;this.button.onClick(e,d,c,b)},this))},addDropdown:function(a,b){a.addClass('redactor-toolbar-link-dropdown').attr('aria-haspopup',true);var c=a.attr('rel');this.button.addCallback(a,'dropdown');var d=$('<div class="redactor-dropdown redactor-dropdown-'+this.uuid+' redactor-dropdown-box-'+c+'" style="display: none;">');a.data('dropdown',d);if(b)this.dropdown.build(c,d,b);return d},add:function(a,b){if(!this.opts.toolbar)return;if(this.button.isMobileUndoRedo(a))return"buffer";var c=this.button.build(a,{title:b});c.addClass('redactor-btn-image');this.$toolbar.append($('<li>').append(c));return c},addFirst:function(a,b){if(!this.opts.toolbar)return;if(this.button.isMobileUndoRedo(a))return"buffer";var c=this.button.build(a,{title:b});c.addClass('redactor-btn-image');this.$toolbar.prepend($('<li>').append(c));return c},addAfter:function(a,b,c){if(!this.opts.toolbar)return;if(this.button.isMobileUndoRedo(b))return"buffer";var d=this.button.build(b,{title:c});d.addClass('redactor-btn-image');var e=this.button.get(a);if(e.length!==0)e.parent().after($('<li>').append(d));else this.$toolbar.append($('<li>').append(d));return d},addBefore:function(a,b,c){if(!this.opts.toolbar)return;if(this.button.isMobileUndoRedo(b))return"buffer";var d=this.button.build(b,{title:c});d.addClass('redactor-btn-image');var e=this.button.get(a);if(e.length!==0)e.parent().before($('<li>').append(d));else this.$toolbar.append($('<li>').append(d));return d},remove:function(a){this.button.get(a).remove()},isMobileUndoRedo:function(a){return(a=="undo"||a=="redo")&&!this.utils.isDesktop()}}},caret:function(){return{setStart:function(a){if(!this.utils.isBlock(a)){var b=this.utils.createSpaceElement();$(a).prepend(b);this.caret.setEnd(b)}else{this.caret.set(a,0,a,0)}},setEnd:function(a){a=a[0]||a;if(a.lastChild.nodeType==1){return this.caret.setAfter(a.lastChild)}this.caret.set(a,1,a,1)},set:function(a,b,c,d){a=a[0]||a;c=c[0]||c;if(this.utils.isBlockTag(a.tagName)&&a.innerHTML===''){a.innerHTML=this.opts.invisibleSpace}if(a.tagName=='BR'&&this.opts.linebreaks===false){var f=$(this.opts.emptyHtml)[0];$(a).replaceWith(f);a=f;c=a}this.selection.get();try{this.range.setStart(a,b);this.range.setEnd(c,d)}catch(e){}this.selection.addRange()},setAfter:function(a){try{var b=$(a)[0].tagName;if(b!='BR'&&!this.utils.isBlock(a)){var c=this.utils.createSpaceElement();$(a).after(c);this.caret.setEnd(c)}else{if(b!='BR'&&this.utils.browser('msie')){this.caret.setStart($(a).next())}else{this.caret.setAfterOrBefore(a,'after')}}}catch(e){var c=this.utils.createSpaceElement();$(a).after(c);this.caret.setEnd(c)}},setBefore:function(a){if(this.utils.isBlock(a)){this.caret.setEnd($(a).prev())}else{this.caret.setAfterOrBefore(a,'before')}},setAfterOrBefore:function(a,b){if(!this.utils.browser('msie'))this.$editor.focus();a=a[0]||a;this.selection.get();if(b=='after'){try{this.range.setStartAfter(a);this.range.setEndAfter(a)}catch(e){}}else{try{this.range.setStartBefore(a);this.range.setEndBefore(a)}catch(e){}}this.range.collapse(false);this.selection.addRange()},getOffsetOfElement:function(a){a=a[0]||a;this.selection.get();var b=this.range.cloneRange();b.selectNodeContents(a);b.setEnd(this.range.endContainer,this.range.endOffset);return $.trim(b.toString()).length},getOffset:function(){var a=0;var b=window.getSelection();if(b.rangeCount>0){var c=window.getSelection().getRangeAt(0);var d=c.cloneRange();d.selectNodeContents(this.$editor[0]);d.setEnd(c.endContainer,c.endOffset);a=d.toString().length}return a},setOffset:function(a,b){if(typeof b=='undefined')b=a;if(!this.focus.isFocused())this.focus.setStart();var c=this.selection.get();var d,offset=0;var e=document.createTreeWalker(this.$editor[0],NodeFilter.SHOW_TEXT,null,null);while(d=e.nextNode()){offset+=d.nodeValue.length;if(offset>a){this.range.setStart(d,d.nodeValue.length+a-offset);a=Infinity}if(offset>=b){this.range.setEnd(d,d.nodeValue.length+b-offset);break}}this.range.collapse(false);this.selection.addRange()},setToPoint:function(a,b){this.caret.setOffset(a,b)},getCoords:function(){return this.caret.getOffset()}}},clean:function(){return{onSet:function(c){c=this.clean.savePreCode(c);c=c.replace(/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi,'<pre class="redactor-script-tag" style="display: none;" $1>$2</pre>');c=c.replace(/\$/g,'&#36;');c=c.replace(/<a href="(.*?[^>]?)®(.*?[^>]?)">/gi,'<a href="$1&reg$2">');if(this.opts.replaceDivs&&!this.opts.linebreaks)c=this.clean.replaceDivs(c);if(this.opts.linebreaks)c=this.clean.replaceParagraphsToBr(c);c=this.clean.saveFormTags(c);var d=$('<div>');d.html(c);var e=d.find('font[style]');if(e.length!==0){e.replaceWith(function(){var a=$(this);var b=$('<span>').attr('style',a.attr('style'));return b.append(a.contents())});c=d.html()}d.remove();c=c.replace(/<font(.*?)>/gi,'');c=c.replace(/<\/font>/gi,'');c=this.tidy.load(c);if(this.opts.paragraphize)c=this.paragraphize.load(c);c=this.clean.setVerified(c);c=this.clean.convertInline(c);c=c.replace(/&amp;/g,'&');return c},onSync:function(a){a=a.replace(/\u200B/g,'');a=a.replace(/&#x200b;/gi,'');if(this.opts.cleanSpaces){a=a.replace(/&nbsp;/gi,' ')}if(a.search(/^<p>(||\s||<br\s?\/?>||&nbsp;)<\/p>$/i)!=-1){return''}a=a.replace(/<pre class="redactor-script-tag" style="display: none;"(.*?[^>]?)>([\w\W]*?)<\/pre>/gi,'<script$1>$2</script>');a=this.clean.restoreFormTags(a);var b={'\u2122':'&trade;','\u00a9':'&copy;','\u2026':'&hellip;','\u2014':'&mdash;','\u2010':'&dash;'};$.each(b,function(i,s){a=a.replace(new RegExp(i,'g'),s)});if(this.utils.browser('mozilla')){a=a.replace(/<br\s?\/?>$/gi,'')}a=a.replace(new RegExp('<br\\s?/?></li>','gi'),'</li>');a=a.replace(new RegExp('</li><br\\s?/?>','gi'),'</li>');a=a.replace(/<(.*?)rel="\s*?"(.*?[^>]?)>/gi,'<$1$2">');a=a.replace(/<(.*?)style="\s*?"(.*?[^>]?)>/gi,'<$1$2">');a=a.replace(/="">/gi,'>');a=a.replace(/""">/gi,'">');a=a.replace(/"">/gi,'">');a=a.replace(/<div(.*?)data-tagblock="redactor"(.*?[^>])>/gi,'<div$1$2>');a=a.replace(/<(.*?) data-verified="redactor"(.*?[^>])>/gi,'<$1$2>');var c=$("<div/>").html($.parseHTML(a,document,true));c.find("span").removeAttr("rel");c.find('pre .redactor-invisible-space').each(function(){$(this).contents().unwrap()});a=c.html();a=a.replace(/<img(.*?[^>])rel="(.*?[^>])"(.*?[^>])>/gi,'<img$1$3>');a=a.replace(/<span class="redactor-invisible-space">(.*?)<\/span>/gi,'$1');a=a.replace(/ data-save-url="(.*?[^>])"/gi,'');a=a.replace(/<span(.*?)id="redactor-image-box"(.*?[^>])>([\w\W]*?)<img(.*?)><\/span>/gi,'$3<img$4>');a=a.replace(/<span(.*?)id="redactor-image-resizer"(.*?[^>])>(.*?)<\/span>/gi,'');a=a.replace(/<span(.*?)id="redactor-image-editter"(.*?[^>])>(.*?)<\/span>/gi,'');a=a.replace(/<font(.*?)>/gi,'');a=a.replace(/<\/font>/gi,'');a=this.tidy.load(a);if(this.opts.linkNofollow){a=a.replace(/<a(.*?)rel="nofollow"(.*?[^>])>/gi,'<a$1$2>');a=a.replace(/<a(.*?[^>])>/gi,'<a$1 rel="nofollow">')}a=a.replace(/\sdata-redactor-(tag|class|style)="(.*?[^>])"/gi,'');a=a.replace(new RegExp('<(.*?) data-verified="redactor"(.*?[^>])>','gi'),'<$1$2>');a=a.replace(new RegExp('<(.*?) data-verified="redactor">','gi'),'<$1>');a=a.replace(/&amp;/g,'&');return a},onPaste:function(a,b){a=$.trim(a);a=a.replace(/\$/g,'&#36;');a=a.replace(/<span class="s[0-9]">/gi,'<span>');a=a.replace(/<span class="Apple-converted-space">&nbsp;<\/span>/gi,' ');a=a.replace(/<span class="Apple-tab-span"[^>]*>\t<\/span>/gi,'\t');a=a.replace(/<span[^>]*>(\s|&nbsp;)<\/span>/gi,' ');if(this.opts.pastePlainText){return this.clean.getPlainText(a)}if(!this.utils.isSelectAll()&&typeof b=='undefined'){if(this.utils.isCurrentOrParent(['FIGCAPTION','A'])){return this.clean.getPlainText(a,false)}if(this.utils.isCurrentOrParent('PRE')){a=a.replace(/”/g,'"');a=a.replace(/“/g,'"');a=a.replace(/‘/g,'\'');a=a.replace(/’/g,'\'');return this.clean.getPreCode(a)}if(this.utils.isCurrentOrParent(['BLOCKQUOTE','H1','H2','H3','H4','H5','H6'])){a=this.clean.getOnlyImages(a);if(!this.utils.browser('msie')){var c=this.selection.getBlock();if(c&&c.tagName=='P'){a=a.replace(/<img(.*?)>/gi,'<p><img$1></p>')}}return a}if(this.utils.isCurrentOrParent(['TD'])){a=this.clean.onPasteTidy(a,'td');if(this.opts.linebreaks)a=this.clean.replaceParagraphsToBr(a);a=this.clean.replaceDivsToBr(a);return a}if(this.utils.isCurrentOrParent(['LI'])){return this.clean.onPasteTidy(a,'li')}}a=this.clean.isSingleLine(a,b);if(!this.clean.singleLine){if(this.opts.linebreaks)a=this.clean.replaceParagraphsToBr(a);if(this.opts.replaceDivs)a=this.clean.replaceDivs(a);a=this.clean.saveFormTags(a)}a=this.clean.onPasteWord(a);a=this.clean.onPasteExtra(a);a=this.clean.onPasteTidy(a,'all');if(!this.clean.singleLine&&this.opts.paragraphize){a=this.paragraphize.load(a)}a=this.clean.removeDirtyStyles(a);a=this.clean.onPasteRemoveSpans(a);a=this.clean.onPasteRemoveEmpty(a);a=this.clean.convertInline(a);return a},onPasteWord:function(j){j=j.replace(/<!--[\s\S]*?-->/gi,'');j=j.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,'');j=j.replace(/<o\:p[^>]*>[\s\S]*?<\/o\:p>/gi,'');if(j.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)){j=j.replace(/<!--[\s\S]+?-->/gi,'');j=j.replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,'');j=j.replace(/<(\/?)s>/gi,"<$1strike>");j=j.replace(/ /gi,' ');j=j.replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(a,b){return(b.length>0)?b.replace(/./," ").slice(Math.floor(b.length/2)).split("").join("\u00a0"):''});j=this.clean.onPasteIeFixLinks(j);j=j.replace(/<img(.*?)v:shapes=(.*?)>/gi,'');j=j.replace(/src="file\:\/\/(.*?)"/,'src=""');var k=$("<div/>").html(j);var l=false;var m=1;var n=[];k.find("p[style]").each(function(){var a=$(this).attr('style').match(/mso\-list\:l([0-9]+)\slevel([0-9]+)/);if(a){var b=parseInt(a[1]);var c=parseInt(a[2]);var d=$(this).html().match(/^[\w]+\./)?"ol":"ul";var e=$("<li/>").html($(this).html());e.html(e.html().replace(/^([\w\.]+)</,'<'));e.find("span:first").remove();if(c==1&&$.inArray(b,n)==-1){var f=$("<"+d+"/>").attr({"data-level":c,"data-list":b}).html(e);$(this).replaceWith(f);l=b;n.push(b)}else{if(c>m){var g=k.find('[data-level="'+m+'"][data-list="'+l+'"]');var h=g;for(var i=m;i<c;i++){f=$("<"+d+"/>");f.appendTo(h.find("li").last());h=f}h.attr({"data-level":c,"data-list":b}).html(e)}else{var g=k.find('[data-level="'+c+'"][data-list="'+b+'"]').last();g.append(e)}m=c;l=b;$(this).remove()}}});k.find('[data-level][data-list]').removeAttr('data-level data-list');j=k.html();j=j.replace(/·/g,'');j=j.replace(/<p class="Mso(.*?)"/gi,'<p');j=j.replace(/ class=\"(mso[^\"]*)\"/gi,"");j=j.replace(/ class=(mso\w+)/gi,"");j=j.replace(/<o:p(.*?)>([\w\W]*?)<\/o:p>/gi,'$2');j=j.replace(/\n/g,' ');j=j.replace(/<p>\n?<li>/gi,'<li>')}return j},onPasteExtra:function(a){a=a.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");a=a.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");a=a.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>/gi,'<span style="font-weight: bold;"><span style="font-style: italic;">');a=a.replace(/<span[^>]*font-style: italic[^>]*>/gi,'<span style="font-style: italic;">');a=a.replace(/<span[^>]*font-weight: bold[^>]*>/gi,'<span style="font-weight: bold;">');a=a.replace(/<span[^>]*text-decoration: underline[^>]*>/gi,'<span style="text-decoration: underline;">');a=a.replace(/<img>/gi,'');a=a.replace(/\n{3,}/gi,'\n');a=a.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi,'$2');a=a.replace(/<p><p>/gi,'<p>');a=a.replace(/<\/p><\/p>/gi,'</p>');a=a.replace(/<li>(\s*|\t*|\n*)<p>/gi,'<li>');a=a.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,'</li>');a=a.replace(/<\/p>\s<p/gi,'<\/p><p');a=a.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,'');a=a.replace(/<p>•([\w\W]*?)<\/p>/gi,'<li>$1</li>');if(this.utils.browser('mozilla')){a=a.replace(/<br\s?\/?>$/gi,'')}return a},onPasteTidy:function(a,b){var c=['span','a','pre','blockquote','small','em','strong','code','kbd','mark','address','cite','var','samp','dfn','sup','sub','b','i','u','del','ol','ul','li','dl','dt','dd','p','br','video','audio','iframe','embed','param','object','img','table','td','th','tr','tbody','tfoot','thead','h1','h2','h3','h4','h5','h6'];var d=false;var e=[['a','*'],['img',['src','alt']],['span',['class','rel','data-verified']],['iframe','*'],['video','*'],['audio','*'],['embed','*'],['object','*'],['param','*'],['source','*']];if(b=='all'){d=['p','span','h1','h2','h3','h4','h5','h6'];e=[['table','class'],['td',['colspan','rowspan']],['a','*'],['img',['src','alt','data-redactor-inserted-image']],['span',['class','rel','data-verified']],['iframe','*'],['video','*'],['audio','*'],['embed','*'],['object','*'],['param','*'],['source','*']]}else if(b=='td'){c=['ul','ol','li','span','a','small','em','strong','code','kbd','mark','cite','var','samp','dfn','sup','sub','b','i','u','del','ol','ul','li','dl','dt','dd','br','iframe','video','audio','embed','param','object','img','h1','h2','h3','h4','h5','h6']}else if(b=='li'){c=['ul','ol','li','span','a','small','em','strong','code','kbd','mark','cite','var','samp','dfn','sup','sub','b','i','u','del','br','iframe','video','audio','embed','param','object','img']}var f={deniedTags:(this.opts.deniedTags)?this.opts.deniedTags:false,allowedTags:(this.opts.allowedTags)?this.opts.allowedTags:c,removeComments:true,removePhp:true,removeAttr:(this.opts.removeAttr)?this.opts.removeAttr:false,allowedAttr:(this.opts.allowedAttr)?this.opts.allowedAttr:e,removeEmpty:d};return this.tidy.load(a,f)},onPasteRemoveEmpty:function(a){a=a.replace(/<(p|h[1-6])>(|\s|\n|\t|<br\s?\/?>)<\/(p|h[1-6])>/gi,'');if(!this.opts.linebreaks)a=a.replace(/<br>$/i,'');return a},onPasteRemoveSpans:function(a){a=a.replace(/<span>(.*?)<\/span>/gi,'$1');a=a.replace(/<span[^>]*>\s|&nbsp;<\/span>/gi,' ');return a},onPasteIeFixLinks:function(a){if(!this.utils.browser('msie'))return a;var b=$.trim(a);if(b.search(/^<a(.*?)>(.*?)<\/a>$/i)===0){a=a.replace(/^<a(.*?)>(.*?)<\/a>$/i,"$2")}return a},isSingleLine:function(a,b){this.clean.singleLine=false;if(!this.utils.isSelectAll()&&typeof b=='undefined'){var c=this.opts.blockLevelElements.join('|').replace('P|','').replace('DIV|','');var d=a.match(new RegExp('</('+c+')>','gi'));var e=a.match(/<\/(p|div)>/gi);if(!d&&(e===null||(e&&e.length<=1))){var f=a.match(/<br\s?\/?>/gi);if(!f){this.clean.singleLine=true;a=a.replace(/<\/?(p|div)(.*?)>/gi,'')}}}return a},stripTags:function(c,d){d=(((d||'')+'').toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join('');var e=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return c.replace(e,function(a,b){return d.indexOf('<'+b.toLowerCase()+'>')>-1?a:''})},savePreCode:function(a){a=this.clean.savePreFormatting(a);a=this.clean.saveCodeFormatting(a);a=this.clean.restoreSelectionMarker(a);return a},savePreFormatting:function(b){var c=b.match(/<pre(.*?)>([\w\W]*?)<\/pre>/gi);if(c!==null){$.each(c,$.proxy(function(i,s){var a=s.match(/<pre(.*?)>([\w\W]*?)<\/pre>/i);a[2]=a[2].replace(/<br\s?\/?>/g,'\n');a[2]=a[2].replace(/&nbsp;/g,' ');if(this.opts.preSpaces){a[2]=a[2].replace(/\t/g,Array(this.opts.preSpaces+1).join(' '))}a[2]=this.clean.encodeEntities(a[2]);a[2]=a[2].replace(/\$/g,'&#36;');b=b.replace(s,'<pre'+a[1]+'>'+a[2]+'</pre>')},this))}return b},saveCodeFormatting:function(b){var c=b.match(/<code(.*?)>([\w\W]*?)<\/code>/gi);if(c!==null){$.each(c,$.proxy(function(i,s){var a=s.match(/<code(.*?)>([\w\W]*?)<\/code>/i);a[2]=a[2].replace(/&nbsp;/g,' ');a[2]=this.clean.encodeEntities(a[2]);a[2]=a[2].replace(/\$/g,'&#36;');b=b.replace(s,'<code'+a[1]+'>'+a[2]+'</code>')},this))}return b},restoreSelectionMarker:function(a){a=a.replace(/&lt;span id=&quot;selection-marker-([0-9])&quot; class=&quot;redactor-selection-marker&quot; data-verified=&quot;redactor&quot;&gt;​&lt;\/span&gt;/g,'<span id="selection-marker-$1" class="redactor-selection-marker" data-verified="redactor">​</span>');return a},getTextFromHtml:function(a){a=a.replace(/<br\s?\/?>|<\/H[1-6]>|<\/p>|<\/div>|<\/li>|<\/td>/gi,'\n');var b=document.createElement('div');b.innerHTML=a;a=b.textContent||b.innerText;return $.trim(a)},getPlainText:function(a,b){a=this.clean.getTextFromHtml(a);a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/\n\n/g,"\n");a=a.replace(/\n/g,'<br />');if(this.opts.paragraphize&&typeof b=='undefined'&&!this.utils.browser('mozilla')){a=this.paragraphize.load(a)}return a},getPreCode:function(a){a=a.replace(/<img(.*?) style="(.*?)"(.*?[^>])>/gi,'<img$1$3>');a=a.replace(/<img(.*?)>/gi,'&lt;img$1&gt;');a=this.clean.getTextFromHtml(a);if(this.opts.preSpaces){a=a.replace(/\t/g,Array(this.opts.preSpaces+1).join(' '))}a=this.clean.encodeEntities(a);return a},getOnlyImages:function(a){a=a.replace(/<img(.*?)>/gi,'[img$1]');a=a.replace(/<([Ss]*?)>/gi,'');a=a.replace(/\[img(.*?)\]/gi,'<img$1>');return a},getOnlyLinksAndImages:function(a){a=a.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');a=a.replace(/<img(.*?)>/gi,'[img$1]');a=a.replace(/<(.*?)>/gi,'');a=a.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');a=a.replace(/\[img(.*?)\]/gi,'<img$1>');return a},encodeEntities:function(a){a=String(a).replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"');return a.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')},removeDirtyStyles:function(a){if(this.utils.browser('msie'))return a;var b=document.createElement('div');b.innerHTML=a;this.clean.clearUnverifiedRemove($(b));a=b.innerHTML;$(b).remove();return a},clearUnverified:function(){if(this.utils.browser('msie'))return;this.clean.clearUnverifiedRemove(this.$editor);var a=this.$editor.find('h1, h2, h3, h4, h5, h6');a.find('span').removeAttr('style');a.find(this.opts.verifiedTags.join(', ')).removeAttr('style');this.code.sync()},clearUnverifiedRemove:function(b){b.find(this.opts.verifiedTags.join(', ')).removeAttr('style');b.find('span').not('[data-verified="redactor"]').removeAttr('style');b.find('span[data-verified="redactor"], img[data-verified="redactor"]').each(function(i,s){var a=$(s);a.attr('style',a.attr('rel'))})},cleanEmptyParagraph:function(){},setVerified:function(a){if(this.utils.browser('msie'))return a;a=a.replace(new RegExp('<img(.*?[^>])>','gi'),'<img$1 data-verified="redactor">');a=a.replace(new RegExp('<span(.*?[^>])>','gi'),'<span$1 data-verified="redactor">');var b=a.match(new RegExp('<(span|img)(.*?)style="(.*?)"(.*?[^>])>','gi'));if(b){var c=b.length;for(var i=0;i<c;i++){try{var d=b[i].replace(/style="(.*?)"/i,'style="$1" rel="$1"');a=a.replace(b[i],d)}catch(e){}}}return a},convertInline:function(c){var d=$('<div />').html(c);var e=this.opts.inlineTags;e.push('span');d.find(e.join(',')).each(function(){var a=$(this);var b=this.tagName.toLowerCase();a.attr('data-redactor-tag',b);if(b=='span'){if(a.attr('style'))a.attr('data-redactor-style',a.attr('style'));else if(a.attr('class'))a.attr('data-redactor-class',a.attr('class'))}});c=d.html();d.remove();return c},normalizeLists:function(){this.$editor.find('li').each(function(i,s){var a=$(s).next();if(a.length!==0&&(a[0].tagName=='UL'||a[0].tagName=='OL')){$(s).append(a)}})},removeSpaces:function(a){a=a.replace(/\n/g,'');a=a.replace(/[\t]*/g,'');a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/g,' ');a=a.replace(/[\s\n]*$/g,' ');a=a.replace(/>\s{2,}</g,'> <');a=a.replace(/\n\n/g,"\n");a=a.replace(/\u200B/g,'');return a},replaceDivs:function(a){if(this.opts.linebreaks){a=a.replace(/<div><br\s?\/?><\/div>/gi,'<br />');a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,'$2<br />')}else{a=a.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,'<p$1>$2</p>')}a=a.replace(/<div(.*?[^>])>/gi,'');a=a.replace(/<\/div>/gi,'');return a},replaceDivsToBr:function(a){a=a.replace(/<div\s(.*?)>/gi,'<p>');a=a.replace(/<div><br\s?\/?><\/div>/gi,'<br /><br />');a=a.replace(/<div>([\w\W]*?)<\/div>/gi,'$1<br /><br />');return a},replaceParagraphsToBr:function(a){a=a.replace(/<p\s(.*?)>/gi,'<p>');a=a.replace(/<p><br\s?\/?><\/p>/gi,'<br />');a=a.replace(/<p>([\w\W]*?)<\/p>/gi,'$1<br /><br />');a=a.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi,'</blockquote>');return a},saveFormTags:function(a){return a.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>')},restoreFormTags:function(a){return a.replace(/<section(.*?) rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,'<form$1$2>$3</form>')}}},code:function(){return{set:function(a){a=$.trim(a.toString());a=this.clean.onSet(a);if(this.utils.browser('msie')){a=a.replace(/<span(.*?)id="selection-marker-(1|2)"(.*?)><\/span>/gi,'')}this.$editor.html(a);this.code.sync();if(a!=='')this.placeholder.remove();setTimeout($.proxy(this.buffer.add,this),15);if(this.start===false)this.observe.load()},get:function(){var a=this.$textarea.val();if(this.opts.replaceDivs)a=this.clean.replaceDivs(a);if(this.opts.linebreaks)a=this.clean.replaceParagraphsToBr(a);a=this.tabifier.get(a);return a},sync:function(){setTimeout($.proxy(this.code.startSync,this),10)},startSync:function(){var b=this.$editor.html();if(this.code.syncCode&&this.code.syncCode==b||(this.start&&b=='')){return}this.code.syncCode=b;b=this.core.setCallback('syncBefore',b);b=this.clean.onSync(b);this.$textarea.val(b);this.core.setCallback('sync',b);if(this.start===false){this.core.setCallback('change',b)}this.start=false;if(this.autosave.html==false){this.autosave.html=this.code.get()}if(this.opts.codemirror){this.$textarea.next('.CodeMirror').each(function(i,a){a.CodeMirror.setValue(b)})}this.autosave.onChange();this.autosave.enable()},toggle:function(){if(this.opts.visual){this.code.showCode()}else{this.code.showVisual()}},showCode:function(){this.selection.save();this.code.offset=this.caret.getOffset();var b=$(window).scrollTop();var c=this.$editor.innerWidth(),height=this.$editor.innerHeight();this.$editor.hide();var d=this.$textarea.val();this.modified=this.clean.removeSpaces(d);d=this.tabifier.get(d);var e=0,end=0;var f=$("<div/>").append($.parseHTML(this.clean.onSync(this.$editor.html()),document,true));var g=f.find("span.redactor-selection-marker");if(g.length>0){var h=this.tabifier.get(f.html()).replace(/&amp;/g,'&');if(g.length==1){e=this.utils.strpos(h,f.find("#selection-marker-1").prop("outerHTML"));end=e}else if(g.length==2){e=this.utils.strpos(h,f.find("#selection-marker-1").prop("outerHTML"));end=this.utils.strpos(h,f.find("#selection-marker-2").prop("outerHTML"))-f.find("#selection-marker-1").prop("outerHTML").toString().length}}this.selection.removeMarkers();this.$textarea.val(d);if(this.opts.codemirror){this.$textarea.next('.CodeMirror').each(function(i,a){$(a).show();a.CodeMirror.setValue(d);a.CodeMirror.setSize('100%',height);a.CodeMirror.refresh();if(e==end){a.CodeMirror.setCursor(a.CodeMirror.posFromIndex(e).line,a.CodeMirror.posFromIndex(end).ch)}else{a.CodeMirror.setSelection({line:a.CodeMirror.posFromIndex(e).line,ch:a.CodeMirror.posFromIndex(e).ch},{line:a.CodeMirror.posFromIndex(end).line,ch:a.CodeMirror.posFromIndex(end).ch})}a.CodeMirror.focus()})}else{this.$textarea.height(height).show().focus();this.$textarea.on('keydown.redactor-textarea-indenting',this.code.textareaIndenting);$(window).scrollTop(b);if(this.$textarea[0].setSelectionRange){this.$textarea[0].setSelectionRange(e,end)}this.$textarea[0].scrollTop=0}this.opts.visual=false;this.button.setInactiveInCode();this.button.setActive('html');this.core.setCallback('source',d)},showVisual:function(){var b;if(this.opts.visual)return;var c=0,end=0;if(this.opts.codemirror){var d;this.$textarea.next('.CodeMirror').each(function(i,a){d=a.CodeMirror.listSelections();c=a.CodeMirror.indexFromPos(d[0].anchor);end=a.CodeMirror.indexFromPos(d[0].head);b=a.CodeMirror.getValue()})}else{c=this.$textarea.get(0).selectionStart;end=this.$textarea.get(0).selectionEnd;b=this.$textarea.hide().val()}if(c>end&&end>0){var e=end;var f=c;c=e;end=f}c=this.code.enlargeOffset(b,c);end=this.code.enlargeOffset(b,end);b=b.substr(0,c)+this.selection.getMarkerAsHtml(1)+b.substr(c);if(end>c){var g=this.selection.getMarkerAsHtml(1).toString().length;b=b.substr(0,end+g)+this.selection.getMarkerAsHtml(2)+b.substr(end+g)}if(this.modified!==this.clean.removeSpaces(b)){this.code.set(b)}if(this.opts.codemirror){this.$textarea.next('.CodeMirror').hide()}this.$editor.show();if(!this.utils.isEmpty(b)){this.placeholder.remove()}this.selection.restore();this.$textarea.off('keydown.redactor-textarea-indenting');this.button.setActiveInVisual();this.button.setInactive('html');this.observe.load();this.opts.visual=true;this.core.setCallback('visual',b)},textareaIndenting:function(e){if(e.keyCode!==9)return true;var a=this.$textarea;var b=a.get(0).selectionStart;a.val(a.val().substring(0,b)+"\t"+a.val().substring(a.get(0).selectionEnd));a.get(0).selectionStart=a.get(0).selectionEnd=b+1;return false},enlargeOffset:function(a,b){var d=a.length;var c=0;if(a[b]=='>'){c++}else{for(var i=b;i<=d;i++){c++;if(a[i]=='>'){break}else if(a[i]=='<'||i==d){c=0;break}}}return b+c}}},core:function(){return{getObject:function(){return $.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getElement:function(){return this.$element},getTextarea:function(){return this.$textarea},getToolbar:function(){return(this.$toolbar)?this.$toolbar:false},addEvent:function(a){this.core.event=a},getEvent:function(){return this.core.event},setCallback:function(d,e,f){var g=d+'Callback';var h='redactor';var i=this.opts[g];if(this.$textarea){var j=false;var k=$._data(this.$textarea[0],'events');if(typeof k!='undefined'&&typeof k[g]!='undefined'){$.each(k[g],$.proxy(function(a,b){if(b['namespace']==h){var c=(typeof c=='undefined')?[e]:[e,c];j=(typeof c=='undefined')?b.handler.call(this,e):b.handler.call(this,e,c)}},this))}if(j)return j}if($.isFunction(i)){return(typeof f=='undefined')?i.call(this,e):i.call(this,e,f)}else{return(typeof f=='undefined')?e:f}},destroy:function(){this.opts.destroyed=true;this.core.setCallback('destroy');this.$element.off('.redactor').removeData('redactor');this.$editor.off('.redactor');$(document).off('mousedown.redactor-blur.'+this.uuid);$(document).off('mousedown.redactor.'+this.uuid);$(document).off('click.redactor-image-delete.'+this.uuid);$(document).off('click.redactor-image-resize-hide.'+this.uuid);$(document).off('touchstart.redactor.'+this.uuid+' click.redactor.'+this.uuid);$("body").off('scroll.redactor.'+this.uuid);$(this.opts.toolbarFixedTarget).off('scroll.redactor.'+this.uuid);this.$editor.removeClass('redactor-editor redactor-linebreaks redactor-placeholder');this.$editor.removeAttr('contenteditable');var b=this.code.get();if(this.opts.toolbar){this.$toolbar.find('a').each(function(){var a=$(this);if(a.data('dropdown')){a.data('dropdown').remove();a.data('dropdown',{})}})}if(this.build.isTextarea()){this.$box.after(this.$element);this.$box.remove();this.$element.val(b).show()}else{this.$box.after(this.$editor);this.$box.remove();this.$element.html(b).show()}if(this.$pasteBox)this.$pasteBox.remove();if(this.$modalBox)this.$modalBox.remove();if(this.$modalOverlay)this.$modalOverlay.remove();$('.redactor-toolbar-tooltip-'+this.uuid).remove();clearInterval(this.autosaveInterval)}}},dropdown:function(){return{build:function(g,h,j){if(g=='formatting'&&this.opts.formattingAdd){$.each(this.opts.formattingAdd,$.proxy(function(i,s){var a=s.tag,func;if(typeof s['class']!='undefined'){a=a+'-'+s['class']}s.type=(this.utils.isBlockTag(s.tag))?'block':'inline';if(typeof s.func!=="undefined"){func=s.func}else{func=(s.type=='inline')?'inline.formatting':'block.formatting'}if(this.opts.linebreaks&&s.type=='block'&&s.tag=='p')return;this.formatting[a]={tag:s.tag,style:s.style,'class':s['class'],attr:s.attr,data:s.data,clear:s.clear};j[a]={func:func,title:s.title}},this))}$.each(j,$.proxy(function(c,d){var f=$('<a href="#" class="redactor-dropdown-'+c+'" role="button">'+d.title+'</a>');if(g=='formatting')f.addClass('redactor-formatting-'+c);f.on('click',$.proxy(function(e){e.preventDefault();var a='func';var b=d.func;if(d.command){a='command';b=d.command}else if(d.dropdown){a='dropdown';b=d.dropdown}if($(e.target).hasClass('redactor-dropdown-link-inactive'))return;this.button.onClick(e,c,a,b);this.dropdown.hideAll()},this));this.observe.addDropdown(f,c,d);h.append(f)},this))},show:function(e,a){if(!this.opts.visual){e.preventDefault();return false}var b=this.button.get(a);var c=b.data('dropdown').appendTo(document.body);if(this.opts.highContrast){c.addClass("redactor-dropdown-contrast")}if(b.hasClass('dropact')){this.dropdown.hideAll()}else{this.dropdown.hideAll();this.observe.dropdowns();this.core.setCallback('dropdownShow',{dropdown:c,key:a,button:b});this.button.setActive(a);b.addClass('dropact');var d=b.offset();var f=c.width();if((d.left+f)>$(document).width()){d.left=Math.max(0,d.left-f)}var g=d.left+'px';if(this.$toolbar.hasClass('toolbar-fixed-box')){var h=this.$toolbar.innerHeight()+this.opts.toolbarFixedTopOffset;var i='fixed';if(this.opts.toolbarFixedTarget!==document){h=(this.$toolbar.innerHeight()+this.$toolbar.offset().top)+this.opts.toolbarFixedTopOffset;i='absolute'}c.css({position:i,left:g,top:h+'px'}).show()}else{var h=(b.innerHeight()+d.top)+'px';c.css({position:'absolute',left:g,top:h}).show()}this.core.setCallback('dropdownShown',{dropdown:c,key:a,button:b});this.$dropdown=c}$(document).one('click.redactor-dropdown',$.proxy(this.dropdown.hide,this));this.$editor.one('click.redactor-dropdown',$.proxy(this.dropdown.hide,this));$(document).one('keyup.redactor-dropdown',$.proxy(this.dropdown.closeHandler,this));c.on('mouseover.redactor-dropdown',$.proxy(this.utils.disableBodyScroll,this)).on('mouseout.redactor-dropdown',$.proxy(this.utils.enableBodyScroll,this));e.stopPropagation()},closeHandler:function(e){if(e.which!=this.keyCode.ESC)return;this.dropdown.hideAll();this.$editor.focus()},hideAll:function(){this.$toolbar.find('a.dropact').removeClass('redactor-act').removeClass('dropact');this.utils.enableBodyScroll();$('.redactor-dropdown-'+this.uuid).hide();$('.redactor-dropdown-link-selected').removeClass('redactor-dropdown-link-selected');if(this.$dropdown){this.$dropdown.off('.redactor-dropdown');this.core.setCallback('dropdownHide',this.$dropdown);this.$dropdown=false}},hide:function(e){var a=$(e.target);if(!a.hasClass('dropact')&&!a.hasClass('redactor-dropdown-link-inactive')){if(a.hasClass('redactor-dropdown')){a.removeClass('dropact');a.off('mouseover mouseout')}this.dropdown.hideAll()}}}},file:function(){return{show:function(){this.modal.load('file',this.lang.get('file'),700);this.upload.init('#redactor-modal-file-upload',this.opts.fileUpload,this.file.insert);this.selection.save();this.selection.get();var a=this.sel.toString();$('#redactor-filename').val(a);this.modal.show()},insert:function(a,b,e){if(typeof a.error!='undefined'){this.modal.close();this.selection.restore();this.core.setCallback('fileUploadError',a);return}var c;if(typeof a=='string'){c=a}else{var d=$('#redactor-filename').val();if(typeof d=='undefined'||d==='')d=a.filename;c='<a href="'+a.filelink+'" id="filelink-marker">'+d+'</a>'}if(b){this.selection.removeMarkers();var f=this.selection.getMarker();this.insert.nodeToCaretPositionFromPoint(e,f)}else{this.modal.close()}this.selection.restore();this.buffer.set();this.insert.htmlWithoutClean(c);if(typeof a=='string')return;var g=$(this.$editor.find('a#filelink-marker'));if(g.length!==0){g.removeAttr('id').removeAttr('style')}else g=false;this.core.setCallback('fileUpload',g,a)}}},focus:function(){return{setStart:function(){this.$editor.focus();var a=this.$editor.children().first();if(a.length===0)return;if(a[0].length===0||a[0].tagName=='BR'||a[0].nodeType==3){return}if(a[0].tagName=='UL'||a[0].tagName=='OL'){var b=a.find('li').first();if(!this.utils.isBlock(b)&&b.text()===''){this.caret.setStart(b);return}}if(this.opts.linebreaks&&!this.utils.isBlockTag(a[0].tagName)){this.selection.get();this.range.setStart(this.$editor[0],0);this.range.setEnd(this.$editor[0],0);this.selection.addRange();return}this.caret.setStart(a)},setEnd:function(){var a=this.$editor.children().last();this.$editor.focus();if(a.size()===0)return;if(this.utils.isEmpty(this.$editor.html())){this.selection.get();this.range.collapse(true);this.range.setStartAfter(a[0]);this.range.setEnd(a[0],0);this.selection.addRange()}else{this.selection.get();this.range.selectNodeContents(a[0]);this.range.collapse(false);this.selection.addRange()}},isFocused:function(){return this.$editor[0]===document.activeElement}}},image:function(){return{show:function(){this.modal.load('image',this.lang.get('image'),700);this.upload.init('#redactor-modal-image-droparea',this.opts.imageUpload,this.image.insert);this.selection.save();this.modal.show()},showEdit:function(a){var b=a.closest('a',this.$editor[0]);this.modal.load('imageEdit',this.lang.get('edit'),705);this.modal.createCancelButton();this.image.buttonDelete=this.modal.createDeleteButton(this.lang.get('_delete'));this.image.buttonSave=this.modal.createActionButton(this.lang.get('save'));this.image.buttonDelete.on('click',$.proxy(function(){this.image.remove(a)},this));this.image.buttonSave.on('click',$.proxy(function(){this.image.update(a)},this));$('.redactor-link-tooltip').remove();$('#redactor-image-title').val(a.attr('alt'));if(!this.opts.imageLink)$('.redactor-image-link-option').hide();else{var c=$('#redactor-image-link');c.attr('href',a.attr('src'));if(b.length!==0){c.val(b.attr('href'));if(b.attr('target')=='_blank')$('#redactor-image-link-blank').prop('checked',true)}}if(!this.opts.imagePosition)$('.redactor-image-position-option').hide();else{var d=(a.css('display')=='block'&&a.css('float')=='none')?'center':a.css('float');$('#redactor-image-align').val(d)}this.modal.show();$('#redactor-image-title').focus()},setFloating:function(a){var b=$('#redactor-image-align').val();var c='';var d='';var e='';switch(b){case'left':c='left';e='0 '+this.opts.imageFloatMargin+' '+this.opts.imageFloatMargin+' 0';break;case'right':c='right';e='0 0 '+this.opts.imageFloatMargin+' '+this.opts.imageFloatMargin;break;case'center':d='block';e='auto';break}a.css({'float':c,display:d,margin:e});a.attr('rel',a.attr('style'))},update:function(b){this.image.hideResize();this.buffer.set();var c=b.closest('a',this.$editor[0]);var d=$('#redactor-image-title').val().replace(/(<([^>]+)>)/ig,"");b.attr('alt',d);this.image.setFloating(b);var e=$.trim($('#redactor-image-link').val());var e=e.replace(/(<([^>]+)>)/ig,"");if(e!==''){var f='((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}';var g=new RegExp('^(http|ftp|https)://'+f,'i');var h=new RegExp('^'+f,'i');if(e.search(g)==-1&&e.search(h)===0&&this.opts.linkProtocol){e=this.opts.linkProtocol+'://'+e}var i=($('#redactor-image-link-blank').prop('checked'))?true:false;if(c.length===0){var a=$('<a href="'+e+'">'+this.utils.getOuterHtml(b)+'</a>');if(i)a.attr('target','_blank');b.replaceWith(a)}else{c.attr('href',e);if(i){c.attr('target','_blank')}else{c.removeAttr('target')}}}else if(c.length!==0){c.replaceWith(this.utils.getOuterHtml(b))}this.modal.close();this.observe.images();this.code.sync()},setEditable:function(a){if(this.opts.imageEditable){a.on('dragstart',$.proxy(this.image.onDrag,this))}var b=$.proxy(function(e){this.observe.image=a;this.image.resizer=this.image.loadEditableControls(a);$(document).on('mousedown.redactor-image-resize-hide.'+this.uuid,$.proxy(this.image.hideResize,this));if(!this.opts.imageResizable)return;this.image.resizer.on('mousedown.redactor touchstart.redactor',$.proxy(function(e){this.image.setResizable(e,a)},this))},this);a.off('mousedown.redactor').on('mousedown.redactor',$.proxy(this.image.hideResize,this));a.off('click.redactor touchstart.redactor').on('click.redactor touchstart.redactor',b)},setResizable:function(e,a){e.preventDefault();this.image.resizeHandle={x:e.pageX,y:e.pageY,el:a,ratio:a.width()/a.height(),h:a.height()};e=e.originalEvent||e;if(e.targetTouches){this.image.resizeHandle.x=e.targetTouches[0].pageX;this.image.resizeHandle.y=e.targetTouches[0].pageY}this.image.startResize()},startResize:function(){$(document).on('mousemove.redactor-image-resize touchmove.redactor-image-resize',$.proxy(this.image.moveResize,this));$(document).on('mouseup.redactor-image-resize touchend.redactor-image-resize',$.proxy(this.image.stopResize,this))},moveResize:function(e){e.preventDefault();e=e.originalEvent||e;var a=this.image.resizeHandle.h;if(e.targetTouches)a+=(e.targetTouches[0].pageY-this.image.resizeHandle.y);else a+=(e.pageY-this.image.resizeHandle.y);var b=Math.round(a*this.image.resizeHandle.ratio);if(a<50||b<100)return;var a=Math.round(this.image.resizeHandle.el.width()/this.image.resizeHandle.ratio);this.image.resizeHandle.el.attr({width:b,height:a});this.image.resizeHandle.el.width(b);this.image.resizeHandle.el.height(a);this.code.sync()},stopResize:function(){this.handle=false;$(document).off('.redactor-image-resize');this.image.hideResize()},onDrag:function(e){if(this.$editor.find('#redactor-image-box').length!==0){e.preventDefault();return false}this.$editor.on('drop.redactor-image-inside-drop',$.proxy(function(){setTimeout($.proxy(this.image.onDrop,this),1)},this))},onDrop:function(){this.image.fixImageSourceAfterDrop();this.observe.images();this.$editor.off('drop.redactor-image-inside-drop');this.clean.clearUnverified();this.code.sync()},fixImageSourceAfterDrop:function(){this.$editor.find('img[data-save-url]').each(function(){var a=$(this);a.attr('src',a.attr('data-save-url'));a.removeAttr('data-save-url')})},hideResize:function(e){if(e&&$(e.target).closest('#redactor-image-box',this.$editor[0]).length!==0)return;if(e&&e.target.tagName=='IMG'){var a=$(e.target);a.attr('data-save-url',a.attr('src'))}var b=this.$editor.find('#redactor-image-box');if(b.length===0)return;$('#redactor-image-editter').remove();$('#redactor-image-resizer').remove();b.find('img').css({marginTop:b[0].style.marginTop,marginBottom:b[0].style.marginBottom,marginLeft:b[0].style.marginLeft,marginRight:b[0].style.marginRight});b.css('margin','');b.find('img').css('opacity','');b.replaceWith(function(){return $(this).contents()});$(document).off('mousedown.redactor-image-resize-hide.'+this.uuid);if(typeof this.image.resizeHandle!=='undefined'){this.image.resizeHandle.el.attr('rel',this.image.resizeHandle.el.attr('style'))}this.code.sync()},loadResizableControls:function(a,b){if(this.opts.imageResizable&&!this.utils.isMobile()){var c=$('<span id="redactor-image-resizer" data-redactor="verified"></span>');if(!this.utils.isDesktop()){c.css({width:'15px',height:'15px'})}c.attr('contenteditable',false);b.append(c);b.append(a);return c}else{b.append(a);return false}},loadEditableControls:function(a){var b=$('<span id="redactor-image-box" data-redactor="verified">');b.css('float',a.css('float')).attr('contenteditable',false);if(a[0].style.margin!='auto'){b.css({marginTop:a[0].style.marginTop,marginBottom:a[0].style.marginBottom,marginLeft:a[0].style.marginLeft,marginRight:a[0].style.marginRight});a.css('margin','')}else{b.css({'display':'block','margin':'auto'})}a.css('opacity','.5').after(b);if(this.opts.imageEditable){this.image.editter=$('<span id="redactor-image-editter" data-redactor="verified">'+this.lang.get('edit')+'</span>');this.image.editter.attr('contenteditable',false);this.image.editter.on('click',$.proxy(function(){this.image.showEdit(a)},this));b.append(this.image.editter);var c=this.image.editter.innerWidth();this.image.editter.css('margin-left','-'+c/2+'px')}return this.image.loadResizableControls(a,b)},remove:function(a){var b=$(a);var c=b.closest('a',this.$editor[0]);var d=b.closest('figure',this.$editor[0]);var e=b.parent();if($('#redactor-image-box').length!==0){e=$('#redactor-image-box').parent()}var f;if(d.length!==0){f=d.next();d.remove()}else if(c.length!==0){e=c.parent();c.remove()}else{b.remove()}$('#redactor-image-box').remove();if(d.length!==0){this.caret.setStart(f)}else{this.caret.setStart(e)}this.core.setCallback('imageDelete',b[0].src,b);this.modal.close();this.code.sync()},insert:function(a,b,e){if(typeof a.error!='undefined'){this.modal.close();this.selection.restore();this.core.setCallback('imageUploadError',a);return}var c;if(typeof a=='string'){c=$(a).attr('data-redactor-inserted-image','true')}else{c=$('<img>');c.attr('src',a.filelink).attr('data-redactor-inserted-image','true')}var d=c;var f=this.utils.isCurrentOrParent('P');if(f){d=$('<blockquote />').append(c)}if(b){this.selection.removeMarkers();var g=this.selection.getMarker();this.insert.nodeToCaretPositionFromPoint(e,g)}else{this.modal.close()}this.selection.restore();this.buffer.set();this.insert.html(this.utils.getOuterHtml(d),false);var h=this.$editor.find('img[data-redactor-inserted-image=true]').removeAttr('data-redactor-inserted-image');if(f){h.parent().contents().unwrap().wrap('<p />')}else if(this.opts.linebreaks){if(!this.utils.isEmpty(this.code.get())){h.before('<br>')}h.after('<br>')}if(typeof a=='string')return;this.core.setCallback('imageUpload',h,a)}}},indent:function(){return{increase:function(){if(!this.utils.browser('msie'))this.$editor.focus();this.buffer.set();this.selection.save();var a=this.selection.getBlock();if(a&&a.tagName=='LI'){this.indent.increaseLists()}else if(a===false&&this.opts.linebreaks){this.indent.increaseText()}else{this.indent.increaseBlocks()}this.selection.restore();this.code.sync()},increaseLists:function(){document.execCommand('indent');this.indent.fixEmptyIndent();this.clean.normalizeLists();this.clean.clearUnverified()},increaseBlocks:function(){$.each(this.selection.getBlocks(),$.proxy(function(i,a){if(a.tagName==='TD'||a.tagName==='TH')return;var b=this.utils.getAlignmentElement(a);var c=this.utils.normalize(b.css('margin-left'))+this.opts.indentValue;b.css('margin-left',c+'px')},this))},increaseText:function(){var a=this.selection.wrap('div');$(a).attr('data-tagblock','redactor');$(a).css('margin-left',this.opts.indentValue+'px')},decrease:function(){this.buffer.set();this.selection.save();var a=this.selection.getBlock();if(a&&a.tagName=='LI'){this.indent.decreaseLists()}else{this.indent.decreaseBlocks()}this.selection.restore();this.code.sync()},decreaseLists:function(){document.execCommand('outdent');var a=this.selection.getCurrent();var b=$(a).closest('li',this.$editor[0]);this.indent.fixEmptyIndent();if(!this.opts.linebreaks&&b.length===0){document.execCommand('formatblock',false,'p');this.$editor.find('ul, ol, blockquote, p').each($.proxy(this.utils.removeEmpty,this))}this.clean.clearUnverified()},decreaseBlocks:function(){$.each(this.selection.getBlocks(),$.proxy(function(i,a){var b=this.utils.getAlignmentElement(a);var c=this.utils.normalize(b.css('margin-left'))-this.opts.indentValue;if(c<=0){if(this.opts.linebreaks&&typeof(b.data('tagblock'))!=='undefined'){b.replaceWith(b.html()+'<br />')}else{b.css('margin-left','');this.utils.removeEmptyAttr(b,'style')}}else{b.css('margin-left',c+'px')}},this))},fixEmptyIndent:function(){var a=this.selection.getBlock();if(this.range.collapsed&&a&&a.tagName=='LI'&&this.utils.isEmpty($(a).text())){var b=$(a);b.find('span').not('.redactor-selection-marker').contents().unwrap();b.append('<br>')}}}},inline:function(){return{formatting:function(a){var b,value;if(typeof this.formatting[a].style!='undefined')b='style';else if(typeof this.formatting[a]['class']!='undefined')b='class';if(b)value=this.formatting[a][b];this.inline.format(this.formatting[a].tag,b,value)},format:function(a,b,c){var d=this.selection.getCurrent();if(d&&d.tagName==='TR')return;if(this.utils.isCurrentOrParent('PRE')||this.utils.isCurrentOrParentHeader())return;var e=['b','bold','i','italic','underline','strikethrough','deleted','superscript','subscript'];var f=['strong','strong','em','em','u','del','del','sup','sub'];for(var i=0;i<e.length;i++){if(a==e[i])a=f[i]}if(this.opts.allowedTags){if($.inArray(a,this.opts.allowedTags)==-1)return}else{if($.inArray(a,this.opts.deniedTags)!==-1)return}this.inline.type=b||false;this.inline.value=c||false;this.buffer.set();if(!this.utils.browser('msie')&&!this.opts.linebreaks){this.$editor.focus()}this.selection.get();if(this.range.collapsed){this.inline.formatCollapsed(a)}else{this.inline.formatMultiple(a)}},formatCollapsed:function(a){var b=this.selection.getCurrent();var c=$(b).closest(a+'[data-redactor-tag='+a+']',this.$editor[0]);if(c.length!==0&&(this.inline.type!='style'&&c[0].tagName!='SPAN')){if(this.utils.isEmpty(c.text())){this.caret.setAfter(c[0]);c.remove();this.code.sync()}else if(this.utils.isEndOfElement(c)){this.caret.setAfter(c[0])}return}var d=$('<'+a+'>').attr('data-verified','redactor').attr('data-redactor-tag',a);d.html(this.opts.invisibleSpace);d=this.inline.setFormat(d);var d=this.insert.node(d);this.caret.setEnd(d);this.code.sync()},formatMultiple:function(f){this.inline.formatConvert(f);this.selection.save();document.execCommand('strikethrough');this.$editor.find('strike').each($.proxy(function(i,s){var a=$(s);this.inline.formatRemoveSameChildren(a,f);var b;if(this.inline.type){b=$('<span>').attr('data-redactor-tag',f).attr('data-verified','redactor');b=this.inline.setFormat(b)}else{b=$('<'+f+'>').attr('data-redactor-tag',f).attr('data-verified','redactor')}a.replaceWith(b.html(a.contents()));var c=b.parent();if(b[0].tagName==='A'&&c&&c[0].tagName==='U'){b.parent().replaceWith(b)}if(f=='span'){if(c&&c[0].tagName==='SPAN'&&this.inline.type==='style'){var d=this.inline.value.split(';');for(var z=0;z<d.length;z++){if(d[z]==='')return;var e=d[z].split(':');c.css(e[0],'');if(this.utils.removeEmptyAttr(c,'style')){c.replaceWith(c.contents())}}}}},this));if(f!='span'){this.$editor.find(this.opts.inlineTags.join(', ')).each($.proxy(function(i,s){var a=$(s);if(s.tagName==='U'&&s.attributes.length===0){a.replaceWith(a.contents());return}var b=a.css('text-decoration');if(b==='line-through'){a.css('text-decoration','');this.utils.removeEmptyAttr(a,'style')}},this))}if(f!='del'){var g=this;this.$editor.find('inline').each(function(i,s){g.utils.replaceToTag(s,'del')})}if(f!='u'){var g=this;this.$editor.find('unline').each(function(i,s){g.utils.replaceToTag(s,'u')})}this.selection.restore();this.code.sync()},formatRemoveSameChildren:function(d,e){var f=this;d.children(e).each(function(){var a=$(this);if(!a.hasClass('redactor-selection-marker')){if(f.inline.type=='style'){var b=f.inline.value.split(';');for(var z=0;z<b.length;z++){if(b[z]==='')return;var c=b[z].split(':');a.css(c[0],'');if(f.utils.removeEmptyAttr(a,'style')){a.replaceWith(a.contents())}}}else{a.contents().unwrap()}}})},formatConvert:function(b){this.selection.save();var c='';if(this.inline.type=='class')c='[data-redactor-class='+this.inline.value+']';else if(this.inline.type=='style'){c='[data-redactor-style="'+this.inline.value+'"]'}var d=this;if(b!='del'){this.$editor.find('del').each(function(i,s){d.utils.replaceToTag(s,'inline')})}if(b!='u'){this.$editor.find('u').each(function(i,s){d.utils.replaceToTag(s,'unline')})}if(b!='span'){this.$editor.find(b).each(function(){var a=$(this);a.replaceWith($('<strike />').html(a.contents()))})}this.$editor.find('[data-redactor-tag="'+b+'"]'+c).each(function(){if(c===''&&b=='span'&&this.tagName.toLowerCase()==b)return;var a=$(this);a.replaceWith($('<strike />').html(a.contents()))});this.selection.restore()},setFormat:function(a){switch(this.inline.type){case'class':if(a.hasClass(this.inline.value)){a.removeClass(this.inline.value);a.removeAttr('data-redactor-class')}else{a.addClass(this.inline.value);a.attr('data-redactor-class',this.inline.value)}break;case'style':a[0].style.cssText=this.inline.value;a.attr('data-redactor-style',this.inline.value);break}return a},removeStyle:function(){this.buffer.set();var b=this.selection.getCurrent();var c=this.selection.getInlines();this.selection.save();if(b&&b.tagName==='SPAN'){var d=$(b);d.removeAttr('style');if(d[0].attributes.length===0){d.replaceWith(d.contents())}}$.each(c,$.proxy(function(i,s){var a=$(s);if($.inArray(s.tagName.toLowerCase(),this.opts.inlineTags)!=-1&&!a.hasClass('redactor-selection-marker')){a.removeAttr('style');if(a[0].attributes.length===0){a.replaceWith(a.contents())}}},this));this.selection.restore();this.code.sync()},removeStyleRule:function(b){this.buffer.set();var c=this.selection.getParent();var d=this.selection.getInlines();this.selection.save();if(c&&c.tagName==='SPAN'){var e=$(c);e.css(b,'');this.utils.removeEmptyAttr(e,'style');if(e[0].attributes.length===0){e.replaceWith(e.contents())}}$.each(d,$.proxy(function(i,s){var a=$(s);if($.inArray(s.tagName.toLowerCase(),this.opts.inlineTags)!=-1&&!a.hasClass('redactor-selection-marker')){a.css(b,'');this.utils.removeEmptyAttr(a,'style');if(a[0].attributes.length===0){a.replaceWith(a.contents())}}},this));this.selection.restore();this.code.sync()},removeFormat:function(){this.buffer.set();var b=this.selection.getCurrent();this.selection.save();document.execCommand('removeFormat');if(b&&b.tagName==='SPAN'){$(b).replaceWith($(b).contents())}$.each(this.selection.getNodes(),$.proxy(function(i,s){var a=$(s);if($.inArray(s.tagName.toLowerCase(),this.opts.inlineTags)!=-1&&!a.hasClass('redactor-selection-marker')){a.replaceWith(a.contents())}},this));this.selection.restore();this.code.sync()},toggleClass:function(a){this.inline.format('span','class',a)},toggleStyle:function(a){this.inline.format('span','style',a)}}},insert:function(){return{set:function(a,b){this.placeholder.remove();a=this.clean.setVerified(a);if(typeof b=='undefined'){a=this.clean.onPaste(a,false)}this.$editor.html(a);this.selection.remove();this.focus.setEnd();this.clean.normalizeLists();this.code.sync();this.observe.load();if(typeof b=='undefined'){setTimeout($.proxy(this.clean.clearUnverified,this),10)}},text:function(a){this.placeholder.remove();a=a.toString();a=$.trim(a);a=this.clean.getPlainText(a,false);this.$editor.focus();if(this.utils.browser('msie')){this.insert.htmlIe(a)}else{this.selection.get();this.range.deleteContents();var b=document.createElement("div");b.innerHTML=a;var c=document.createDocumentFragment(),node,lastNode;while((node=b.firstChild)){lastNode=c.appendChild(node)}this.range.insertNode(c);if(lastNode){var d=this.range.cloneRange();d.setStartAfter(lastNode);d.collapse(true);this.sel.removeAllRanges();this.sel.addRange(d)}}this.code.sync();this.clean.clearUnverified()},htmlWithoutClean:function(a){this.insert.html(a,false)},html:function(a,b){this.placeholder.remove();if(typeof b=='undefined')b=true;if(!this.opts.linebreaks){this.$editor.focus()}a=this.clean.setVerified(a);if(b){a=this.clean.onPaste(a)}if(this.utils.browser('msie')){this.insert.htmlIe(a)}else{if(this.clean.singleLine)this.insert.execHtml(a);else document.execCommand('insertHTML',false,a);this.insert.htmlFixMozilla()}this.clean.normalizeLists();if(!this.opts.linebreaks){this.$editor.find('p').each($.proxy(this.utils.removeEmpty,this))}this.code.sync();this.observe.load();if(b){this.clean.clearUnverified()}},htmlFixMozilla:function(){if(!this.utils.browser('mozilla'))return;var a=$(this.selection.getBlock()).next();if(a.length>0&&a[0].tagName=='P'&&a.html()===''){a.remove()}},htmlIe:function(a){if(this.utils.isIe11()){var b=this.utils.isCurrentOrParent('P');var c=$('<div>').append(a);var d=c.contents().is('p, :header, dl, ul, ol, div, table, td, blockquote, pre, address, section, header, footer, aside, article');if(b&&d)this.insert.ie11FixInserting(b,a);else this.insert.ie11PasteFrag(a);return}document.selection.createRange().pasteHTML(a)},execHtml:function(a){a=this.clean.setVerified(a);this.selection.get();this.range.deleteContents();var b=document.createElement('div');b.innerHTML=a;var c=document.createDocumentFragment(),node,lastNode;while((node=b.firstChild)){lastNode=c.appendChild(node)}this.range.insertNode(c);this.range.collapse(true);this.caret.setAfter(lastNode)},node:function(a,b){a=a[0]||a;var c=this.caret.getOffset();var d=this.utils.getOuterHtml(a);d=this.clean.setVerified(d);if(d.match(/</g)!==null){a=$(d)[0]}this.selection.get();if(b!==false){this.range.deleteContents()}this.range.insertNode(a);this.range.collapse(false);this.selection.addRange();this.caret.setOffset(c);return a},nodeToPoint:function(a,x,y){a=a[0]||a;this.selection.get();var b;if(document.caretPositionFromPoint){var c=document.caretPositionFromPoint(x,y);this.range.setStart(c.offsetNode,c.offset);this.range.collapse(true);this.range.insertNode(a)}else if(document.caretRangeFromPoint){b=document.caretRangeFromPoint(x,y);b.insertNode(a)}else if(typeof document.body.createTextRange!="undefined"){b=document.body.createTextRange();b.moveToPoint(x,y);var d=b.duplicate();d.moveToPoint(x,y);b.setEndPoint("EndToEnd",d);b.select()}},nodeToCaretPositionFromPoint:function(e,a){a=a[0]||a;var b;var x=e.clientX,y=e.clientY;if(document.caretPositionFromPoint){var c=document.caretPositionFromPoint(x,y);var d=document.getSelection();b=d.getRangeAt(0);b.setStart(c.offsetNode,c.offset);b.collapse(true);b.insertNode(a)}else if(document.caretRangeFromPoint){b=document.caretRangeFromPoint(x,y);b.insertNode(a)}else if(typeof document.body.createTextRange!="undefined"){b=document.body.createTextRange();b.moveToPoint(x,y);var f=b.duplicate();f.moveToPoint(x,y);b.setEndPoint("EndToEnd",f);b.select()}},ie11FixInserting:function(a,b){var c=document.createElement('span');c.className='redactor-ie-paste';this.insert.node(c);var d=$(a).html();d='<p>'+d.replace(/<span class="redactor-ie-paste"><\/span>/gi,'</p>'+b+'<p>')+'</p>';d=d.replace(/<p><\/p>/gi,'');$(a).replaceWith(d)},ie11PasteFrag:function(a){this.selection.get();this.range.deleteContents();var b=document.createElement("div");b.innerHTML=a;var c=document.createDocumentFragment(),node,lastNode;while((node=b.firstChild)){lastNode=c.appendChild(node)}this.range.insertNode(c);this.range.collapse(false);this.selection.addRange()}}},keydown:function(){return{init:function(e){if(this.rtePaste)return;var b=e.which;var c=(b>=37&&b<=40);this.keydown.ctrl=e.ctrlKey||e.metaKey;this.keydown.current=this.selection.getCurrent();this.keydown.parent=this.selection.getParent();this.keydown.block=this.selection.getBlock();this.keydown.pre=this.utils.isTag(this.keydown.current,'pre');this.keydown.blockquote=this.utils.isTag(this.keydown.current,'blockquote');this.keydown.figcaption=this.utils.isTag(this.keydown.current,'figcaption');this.shortcuts.init(e,b);if(this.utils.isDesktop()){this.keydown.checkEvents(c,b);this.keydown.setupBuffer(e,b)}this.keydown.addArrowsEvent(c);this.keydown.setupSelectAll(e,b);var d=this.core.setCallback('keydown',e);if(d===false){e.preventDefault();return false}if(this.opts.enterKey&&(this.utils.browser('msie')||this.utils.browser('mozilla'))&&(b===this.keyCode.DOWN||b===this.keyCode.RIGHT)){var f=false;var g=false;if(this.keydown.block&&this.keydown.block.tagName==='TD'){g=$(this.keydown.block).closest('table',this.$editor[0])}if(g&&g.find('td').last()[0]===this.keydown.block){f=true}if(this.utils.isEndOfElement()&&f){var h=$(this.opts.emptyHtml);g.after(h);this.caret.setStart(h)}}if(this.opts.enterKey&&b===this.keyCode.DOWN){this.keydown.onArrowDown()}if(!this.opts.enterKey&&b===this.keyCode.ENTER){e.preventDefault();if(!this.range.collapsed)this.range.deleteContents();return}if(b==this.keyCode.ENTER&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){var j=this.core.setCallback('enter',e);if(j===false){e.preventDefault();return false}if(this.keydown.blockquote&&this.keydown.exitFromBlockquote(e)===true){return false}var k,$next;if(this.keydown.pre){return this.keydown.insertNewLine(e)}else if(this.keydown.blockquote||this.keydown.figcaption){k=this.selection.getCurrent();$next=$(k).next();if($next.length!==0&&$next[0].tagName=='BR'){return this.keydown.insertBreakLine(e)}else if(this.utils.isEndOfElement()&&(k&&k!='SPAN')){return this.keydown.insertDblBreakLine(e)}else{return this.keydown.insertBreakLine(e)}}else if(this.opts.linebreaks&&!this.keydown.block){k=this.selection.getCurrent();$next=$(this.keydown.current).next();if($next.length!==0&&$next[0].tagName=='BR'){return this.keydown.insertBreakLine(e)}else if(k!==false&&$(k).hasClass('redactor-invisible-space')){this.caret.setAfter(k);$(k).contents().unwrap();return this.keydown.insertDblBreakLine(e)}else{if(this.utils.isEndOfEditor()){return this.keydown.insertDblBreakLine(e)}else if($next.length===0&&k===false&&typeof $next.context!='undefined'){return this.keydown.insertBreakLine(e)}return this.keydown.insertBreakLine(e)}}else if(this.opts.linebreaks&&this.keydown.block){setTimeout($.proxy(this.keydown.replaceDivToBreakLine,this),1)}else if(!this.opts.linebreaks&&this.keydown.block){setTimeout($.proxy(this.keydown.replaceDivToParagraph,this),1);if(this.keydown.block.tagName==='LI'){k=this.selection.getCurrent();var l=$(k).closest('li',this.$editor[0]);var m=l.closest('ul,ol',this.$editor[0]);if(l.length!==0&&this.utils.isEmpty(l.html())&&m.next().length===0&&this.utils.isEmpty(m.find("li").last().html())){m.find("li").last().remove();var h=$(this.opts.emptyHtml);m.after(h);this.caret.setStart(h);return false}}}else if(!this.opts.linebreaks&&!this.keydown.block){return this.keydown.insertParagraph(e)}}if(b===this.keyCode.ENTER&&(e.ctrlKey||e.shiftKey)){return this.keydown.onShiftEnter(e)}if(b===this.keyCode.TAB||e.metaKey&&b===221||e.metaKey&&b===219){return this.keydown.onTab(e,b)}if(b===this.keyCode.BACKSPACE||b===this.keyCode.DELETE){var n=this.selection.getNodes();if(n){var o=n.length;var p;for(var i=0;i<o;i++){var q=$(n[i]).children('img');if(q.length!==0){var r=this;$.each(q,function(z,s){var a=$(s);if(a.css('float')!='none')return;r.core.setCallback('imageDelete',s.src,a);p=s})}else if(n[i].tagName=='IMG'){if(p!=n[i]){this.core.setCallback('imageDelete',n[i].src,$(n[i]));p=n[i]}}}}}if(b===this.keyCode.BACKSPACE){var t=this.selection.getBlock();var u=($(t).css('margin-left')!=='0px');if(t&&u&&this.range.collapsed&&this.utils.isStartOfElement()){this.indent.decrease();e.preventDefault();return}if(this.utils.browser('mozilla')){var v=this.selection.getPrev();var w=$(v).prev()[0];if(v&&v.tagName==='HR')$(v).remove();if(w&&w.tagName==='HR')$(w).remove()}this.keydown.removeInvisibleSpace();this.keydown.removeEmptyListInTable(e)}this.code.sync()},checkEvents:function(a,b){if(!a&&(this.core.getEvent()=='click'||this.core.getEvent()=='arrow')){this.core.addEvent(false);if(this.keydown.checkKeyEvents(b)&&this.core.getEvent()=='arrow'){this.buffer.set()}}},checkKeyEvents:function(a){var k=this.keyCode;var b=[k.BACKSPACE,k.DELETE,k.ENTER,k.ESC,k.TAB,k.CTRL,k.META,k.ALT,k.SHIFT];return($.inArray(a,b)==-1)?true:false},addArrowsEvent:function(a){if(!a)return;if((this.core.getEvent()=='click'||this.core.getEvent()=='arrow')){this.core.addEvent(false);return}this.core.addEvent('arrow')},setupBuffer:function(e,a){if(this.keydown.ctrl&&a===90&&!e.shiftKey&&!e.altKey&&this.opts.buffer.length){e.preventDefault();this.buffer.undo();return}else if(this.keydown.ctrl&&a===90&&e.shiftKey&&!e.altKey&&this.opts.rebuffer.length!==0){e.preventDefault();this.buffer.redo();return}else if(!this.keydown.ctrl){if(a==this.keyCode.BACKSPACE||a==this.keyCode.DELETE||(a==this.keyCode.ENTER&&!e.ctrlKey&&!e.shiftKey)){this.buffer.set()}}},setupSelectAll:function(e,a){if(this.keydown.ctrl&&a===65){this.utils.enableSelectAll()}else if(a!=this.keyCode.LEFT_WIN&&!this.keydown.ctrl){this.utils.disableSelectAll()}},onArrowDown:function(){var a=[this.keydown.blockquote,this.keydown.pre,this.keydown.figcaption];for(var i=0;i<a.length;i++){if(a[i]){this.keydown.insertAfterLastElement(a[i]);return false}}},onShiftEnter:function(e){this.buffer.set();if(this.utils.isEndOfElement()){return this.keydown.insertDblBreakLine(e)}return this.keydown.insertBreakLine(e)},onTab:function(e,a){if(!this.opts.tabKey)return true;if(this.utils.isEmpty(this.code.get())&&this.opts.tabAsSpaces===false)return true;e.preventDefault();var b;if(this.keydown.pre&&!e.shiftKey){b=(this.opts.preSpaces)?document.createTextNode(Array(this.opts.preSpaces+1).join('\u00a0')):document.createTextNode('\t');this.insert.node(b);this.code.sync()}else if(this.opts.tabAsSpaces!==false){b=document.createTextNode(Array(this.opts.tabAsSpaces+1).join('\u00a0'));this.insert.node(b);this.code.sync()}else{if(e.metaKey&&a===219)this.indent.decrease();else if(e.metaKey&&a===221)this.indent.increase();else if(!e.shiftKey)this.indent.increase();else this.indent.decrease()}return false},replaceDivToBreakLine:function(){var a=this.selection.getBlock();var b=a.innerHTML.replace(/<br\s?\/?>/gi,'');if((a.tagName==='DIV'||a.tagName==='P')&&b===''&&!$(a).hasClass('redactor-editor')){var c=document.createElement('br');$(a).replaceWith(c);this.caret.setBefore(c);this.code.sync();return false}},replaceDivToParagraph:function(){var a=this.selection.getBlock();var b=a.innerHTML.replace(/<br\s?\/?>/gi,'');if(a.tagName==='DIV'&&this.utils.isEmpty(b)&&!$(a).hasClass('redactor-editor')){var p=document.createElement('p');p.innerHTML=this.opts.invisibleSpace;$(a).replaceWith(p);this.caret.setStart(p);this.code.sync();return false}else if(this.opts.cleanStyleOnEnter&&a.tagName=='P'){$(a).removeAttr('class').removeAttr('style')}},insertParagraph:function(e){e.preventDefault();this.selection.get();var p=document.createElement('p');p.innerHTML=this.opts.invisibleSpace;this.range.deleteContents();this.range.insertNode(p);this.caret.setStart(p);this.code.sync();return false},exitFromBlockquote:function(e){if(!this.utils.isEndOfElement())return;var a=$.trim($(this.keydown.block).html());if(a.search(/(<br\s?\/?>){2}$/i)!=-1){e.preventDefault();if(this.opts.linebreaks){var b=document.createElement('br');$(this.keydown.blockquote).after(b);this.caret.setBefore(b);$(this.keydown.block).html(a.replace(/<br\s?\/?>$/i,''))}else{var c=$(this.opts.emptyHtml);$(this.keydown.blockquote).after(c);this.caret.setStart(c)}return true}return},insertAfterLastElement:function(a){if(!this.utils.isEndOfElement())return;this.buffer.set();if(this.opts.linebreaks){var b=$('<div>').append($.trim(this.$editor.html())).contents();var c=b.last()[0];if(c.tagName=='SPAN'&&c.innerHTML===''){c=b.prev()[0]}if(this.utils.getOuterHtml(c)!=this.utils.getOuterHtml(a))return;var d=document.createElement('br');$(a).after(d);this.caret.setAfter(d)}else{if(this.$editor.contents().last()[0]!==a)return;var e=$(this.opts.emptyHtml);$(a).after(e);this.caret.setStart(e)}},insertNewLine:function(e){e.preventDefault();var a=document.createTextNode('\n');this.selection.get();this.range.deleteContents();this.range.insertNode(a);this.caret.setAfter(a);this.code.sync();return false},insertBreakLine:function(e){return this.keydown.insertBreakLineProcessing(e)},insertDblBreakLine:function(e){return this.keydown.insertBreakLineProcessing(e,true)},insertBreakLineProcessing:function(e,a){e.stopPropagation();this.selection.get();var b=document.createElement('br');if(this.utils.browser('msie')){this.range.collapse(false);this.range.setEnd(this.range.endContainer,this.range.endOffset)}else{this.range.deleteContents()}this.range.insertNode(b);var c=$(b).parent("a");if(c.length>0){c.find(b).remove();c.after(b)}if(a===true){var d=$(b).next();if(d.length!==0&&d[0].tagName==='BR'&&this.utils.isEndOfEditor()){this.caret.setAfter(b);this.code.sync();return false}var f=document.createElement('br');this.range.insertNode(f);this.caret.setAfter(f)}else{if(this.utils.browser('msie')){var g=document.createElement('span');g.innerHTML='&#x200b;';$(b).after(g);this.range.setStartAfter(g);this.range.setEndAfter(g);$(g).remove()}else{var h=document.createRange();h.setStartAfter(b);h.collapse(true);var i=window.getSelection();i.removeAllRanges();i.addRange(h)}}this.code.sync();return false},removeInvisibleSpace:function(){var a=$(this.keydown.current);if(a.text().search(/^\u200B$/g)===0){a.remove()}},removeEmptyListInTable:function(e){var a=$(this.keydown.current);var b=$(this.keydown.parent);var c=a.closest('td',this.$editor[0]);if(c.length!==0&&a.closest('li',this.$editor[0])&&b.children('li').length===1){if(!this.utils.isEmpty(a.text()))return;e.preventDefault();a.remove();b.remove();this.caret.setStart(c)}}}},keyup:function(){return{init:function(e){if(this.rtePaste)return;var a=e.which;this.keyup.current=this.selection.getCurrent();this.keyup.parent=this.selection.getParent();var b=this.utils.isRedactorParent($(this.keyup.parent).parent());var c=this.core.setCallback('keyup',e);if(c===false){e.preventDefault();return false}if(!this.opts.linebreaks&&this.keyup.current.nodeType===3&&this.keyup.current.length<=1&&(this.keyup.parent===false||this.keyup.parent.tagName=='BODY')){this.keyup.replaceToParagraph()}if(!this.opts.linebreaks&&this.utils.isRedactorParent(this.keyup.current)&&this.keyup.current.tagName==='DIV'){this.keyup.replaceToParagraph(false)}if(!this.opts.linebreaks&&$(this.keyup.parent).hasClass('redactor-invisible-space')&&(b===false||b[0].tagName=='BODY')){$(this.keyup.parent).contents().unwrap();this.keyup.replaceToParagraph()}if(this.linkify.isEnabled()&&this.linkify.isKey(a))this.linkify.format();if(a===this.keyCode.DELETE||a===this.keyCode.BACKSPACE){if(this.utils.browser('mozilla')){var d=$(this.keydown.current).closest('td',this.$editor[0]);if(d.size()!==0&&d.text()!==''){e.preventDefault();return false}}this.clean.clearUnverified();if(this.observe.image){e.preventDefault();this.image.hideResize();this.buffer.set();this.image.remove(this.observe.image);this.observe.image=false;return false}this.$editor.find('p').each($.proxy(function(i,s){this.utils.removeEmpty(i,$(s).html())},this));if(this.opts.linebreaks&&this.keyup.current&&this.keyup.current.tagName=='DIV'&&this.utils.isEmpty(this.keyup.current.innerHTML)){$(this.keyup.current).after(this.selection.getMarkerAsHtml());this.selection.restore();$(this.keyup.current).remove()}this.keyup.removeEmptyLists();return this.keyup.formatEmpty(e)}},replaceToParagraph:function(a){var b=$(this.keyup.current);var c;if(a===false){c=$('<p>').append(b.html())}else{c=$('<p>').append(b.clone())}b.replaceWith(c);var d=$(c).next();if(typeof(d[0])!=='undefined'&&d[0].tagName=='BR'){d.remove()}this.caret.setEnd(c)},removeEmptyLists:function(){var b=function(){var a=$.trim(this.innerHTML).replace(/\/t\/n/g,'');if(a===''){$(this).remove()}};this.$editor.find('li').each(b);this.$editor.find('ul, ol').each(b)},formatEmpty:function(e){var a=$.trim(this.$editor.html());if(!this.utils.isEmpty(a))return;e.preventDefault();if(this.opts.linebreaks){this.$editor.html(this.selection.getMarkerAsHtml());this.selection.restore()}else{this.$editor.html(this.opts.emptyHtml);this.focus.setStart()}this.code.sync();return false}}},lang:function(){return{load:function(){this.opts.curLang=this.opts.langs[this.opts.lang]},get:function(a){return(typeof this.opts.curLang[a]!='undefined')?this.opts.curLang[a]:''}}},line:function(){return{insert:function(){this.buffer.set();var a=this.selection.getBlocks();if(a[0]!==false&&this.line.isExceptLastOrFirst(a)){if(!this.utils.browser('msie'))this.$editor.focus();return}if(this.utils.browser('msie')){this.line.insertInIe()}else{this.line.insertInOthersBrowsers()}},isExceptLastOrFirst:function(a){var b=['li','td','th','blockquote','figcaption','pre','dl','dt','dd'];var c=a[0].tagName.toLowerCase();var d=this.selection.getLastBlock();d=(typeof d=='undefined')?c:d.tagName.toLowerCase();var e=$.inArray(c,b)!=-1;var f=$.inArray(d,b)!=-1;if((e&&f)||e){return true}},insertInIe:function(){this.utils.saveScroll();this.buffer.set();this.insert.node(document.createElement('hr'));this.utils.restoreScroll();this.code.sync()},insertInOthersBrowsers:function(){this.buffer.set();var a='<p id="redactor-insert-line"><br /></p>';if(this.opts.linebreaks)a='<br id="redactor-insert-line">';document.execCommand('insertHtml',false,'<hr>'+a);this.line.setFocus();this.code.sync()},setFocus:function(){var a=this.$editor.find('#redactor-insert-line');var b=$(a).next()[0];var c=b;if(this.utils.browser('mozilla')&&b&&b.innerHTML===''){c=$(b).next()[0];$(b).remove()}if(c){a.remove();if(!this.opts.linebreaks){this.$editor.focus();this.line.setStart(c)}}else{a.removeAttr('id');this.line.setStart(a[0])}},setStart:function(a){if(typeof a==='undefined')return;var b=document.createTextNode('\u200B');this.selection.get();this.range.setStart(a,0);this.range.insertNode(b);this.range.collapse(true);this.selection.addRange()}}},link:function(){return{show:function(e){if(typeof e!='undefined'&&e.preventDefault)e.preventDefault();if(!this.observe.isCurrent('a')){this.modal.load('link',this.lang.get('link_insert'),600)}else{this.modal.load('link',this.lang.get('link_edit'),600)}this.modal.createCancelButton();var a=!this.observe.isCurrent('a')?this.lang.get('insert'):this.lang.get('edit');this.link.buttonInsert=this.modal.createActionButton(a);this.selection.get();this.link.getData();this.link.cleanUrl();if(this.link.target=='_blank')$('#redactor-link-blank').prop('checked',true);this.link.$inputUrl=$('#redactor-link-url');this.link.$inputText=$('#redactor-link-url-text');this.link.$inputText.val(this.link.text);this.link.$inputUrl.val(this.link.url);this.link.buttonInsert.on('click',$.proxy(this.link.insert,this));$('.redactor-link-tooltip').remove();this.selection.save();this.modal.show();this.link.$inputUrl.focus()},cleanUrl:function(){var a=self.location.href.replace(/\/$/i,'');if(typeof this.link.url!=="undefined"){this.link.url=this.link.url.replace(a,'');this.link.url=this.link.url.replace(/^\/#/,'#');this.link.url=this.link.url.replace('mailto:','');if(!this.opts.linkProtocol){var b=new RegExp('^(http|ftp|https)://'+self.location.host,'i');this.link.url=this.link.url.replace(b,'')}}},getData:function(){this.link.$node=false;var a=$(this.selection.getCurrent()).closest('a',this.$editor[0]);if(a.length!==0&&a[0].tagName==='A'){this.link.$node=a;this.link.url=a.attr('href');this.link.text=a.text();this.link.target=a.attr('target')}else{this.link.text=this.sel.toString();this.link.url='';this.link.target=''}},insert:function(){this.placeholder.remove();var a='';var b=this.link.$inputUrl.val();var c=this.link.$inputText.val().replace(/(<([^>]+)>)/ig,"");if($.trim(b)===''){this.link.$inputUrl.addClass('redactor-input-error').on('keyup',function(){$(this).removeClass('redactor-input-error');$(this).off('keyup')});return}if(b.search('@')!=-1&&/(http|ftp|https):\/\//i.test(b)===false){b=b.replace('mailto:','');b='mailto:'+b}else if(b.search('#')!==0){if($('#redactor-link-blank').prop('checked')){a='_blank'}var d='((xn--)?[a-z0-9]+(-[a-z0-9]+)*\\.)+[a-z]{2,}';var e=new RegExp('^(http|ftp|https)://'+d,'i');var f=new RegExp('^'+d,'i');var g=new RegExp('\.(html|php)$','i');if(b.search(e)==-1&&b.search(g)==-1&&b.search(f)===0&&this.opts.linkProtocol){b=this.opts.linkProtocol+'://'+b}}this.link.set(c,b,a);this.modal.close()},set:function(a,b,c){a=$.trim(a.replace(/<|>/g,''));this.selection.restore();var d=this.selection.getBlocks();if(a===''&&b==='')return;if(a===''&&b!=='')a=b;if(this.link.$node){this.buffer.set();var e=this.link.$node,$el=e.children();if($el.length>0){while($el.length){$el=$el.children()}$el=$el.end()}else{$el=e}e.attr('href',b);$el.text(a);if(c!==''){e.attr('target',c)}else{e.removeAttr('target')}this.selection.selectElement(e);this.code.sync()}else{if(this.utils.browser('mozilla')&&this.link.text===''){var f=$('<a />').attr('href',b).text(a);if(c!=='')f.attr('target',c);f=$(this.insert.node(f));if(this.opts.linebreaks){f.after('&nbsp;')}this.selection.selectElement(f)}else{var f;if(this.utils.browser('msie')){f=$('<a href="'+b+'">').text(a);if(c!=='')f.attr('target',c);f=$(this.insert.node(f));if(this.selection.getText().match(/\s$/)){f.after(" ")}this.selection.selectElement(f)}else{document.execCommand('createLink',false,b);f=$(this.selection.getCurrent()).closest('a',this.$editor[0]);if(this.utils.browser('mozilla')){f=$('a[_moz_dirty=""]')}if(c!=='')f.attr('target',c);f.removeAttr('style').removeAttr('_moz_dirty');if(this.selection.getText().match(/\s$/)){f.after(" ")}if(this.link.text!==''||this.link.text!=a){if(!this.opts.linebreaks&&d&&d.length<=1){f.text(a)}else if(this.opts.linebreaks){f.text(a)}this.selection.selectElement(f)}}}this.code.sync();this.core.setCallback('insertedLink',f)}setTimeout($.proxy(function(){this.observe.links()},this),5)},unlink:function(e){if(typeof e!='undefined'&&e.preventDefault){e.preventDefault()}var a=this.selection.getNodes();if(!a)return;this.buffer.set();var b=a.length;var c=[];for(var i=0;i<b;i++){if(a[i].tagName==='A'){c.push(a[i])}var d=$(a[i]).closest('a',this.$editor[0]);d.replaceWith(d.contents())}this.core.setCallback('deletedLink',c);$('.redactor-link-tooltip').remove();this.code.sync()},toggleClass:function(a){this.link.setClass(a,'toggleClass')},addClass:function(a){this.link.setClass(a,'addClass')},removeClass:function(a){this.link.setClass(a,'removeClass')},setClass:function(a,b){var c=this.selection.getInlinesTags(['a']);if(c===false)return;$.each(c,function(){$(this)[b](a)})}}},linkify:function(){return{isKey:function(a){return a==this.keyCode.ENTER||a==this.keyCode.SPACE},isEnabled:function(){return this.opts.convertLinks&&(this.opts.convertUrlLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&!this.utils.isCurrentOrParent('PRE')},format:function(){var b=this.linkify,opts=this.opts;this.$editor.find(":not(iframe,img,a,pre)").addBack().contents().filter(function(){return this.nodeType===3&&$.trim(this.nodeValue)!=""&&!$(this).parent().is("pre")&&(this.nodeValue.match(opts.linkify.regexps.youtube)||this.nodeValue.match(opts.linkify.regexps.vimeo)||this.nodeValue.match(opts.linkify.regexps.image)||this.nodeValue.match(opts.linkify.regexps.url))}).each(function(){var a=$(this).text(),html=a;if(opts.convertVideoLinks&&(html.match(opts.linkify.regexps.youtube)||html.match(opts.linkify.regexps.vimeo))){html=b.convertVideoLinks(html)}else if(opts.convertImageLinks&&html.match(opts.linkify.regexps.image)){html=b.convertImages(html)}else if(opts.convertUrlLinks){html=b.convertLinks(html)}$(this).before(a.replace(a,html)).remove()});var c=this.$editor.find('.redactor-linkify-object').each(function(){var a=$(this);a.removeClass('redactor-linkify-object');if(a.attr('class')==='')a.removeAttr('class');return a[0]});setTimeout($.proxy(function(){this.observe.load();this.core.setCallback('linkify',c)},this),100);this.code.sync()},convertVideoLinks:function(a){var b='<iframe class="redactor-linkify-object" width="500" height="281" src="',iframeEnd='" frameborder="0" allowfullscreen></iframe>';if(a.match(this.opts.linkify.regexps.youtube)){a=a.replace(this.opts.linkify.regexps.youtube,b+'//www.youtube.com/embed/$1'+iframeEnd)}if(a.match(this.opts.linkify.regexps.vimeo)){a=a.replace(this.opts.linkify.regexps.vimeo,b+'//player.vimeo.com/video/$2'+iframeEnd)}return a},convertImages:function(a){var b=a.match(this.opts.linkify.regexps.image);if(b){a=a.replace(a,'<img src="'+b+'" class="redactor-linkify-object" />');if(this.opts.linebreaks){if(!this.utils.isEmpty(this.code.get())){a='<br>'+a}}a+='<br>'}return a},convertLinks:function(a){var b=a.match(this.opts.linkify.regexps.url);if(b){b=$.grep(b,function(v,k){return $.inArray(v,b)===k});var c=b.length;for(var i=0;i<c;i++){var d=b[i],text=d,linkProtocol=this.opts.linkProtocol+'://';if(d.match(/(https?|ftp):\/\//i)!==null){linkProtocol=""}if(text.length>this.opts.linkSize){text=text.substring(0,this.opts.linkSize)+'...'}if(text.search('%')===-1){text=decodeURIComponent(text)}var e="\\b";if($.inArray(d.slice(-1),["/","&","="])!=-1){e=""}var f=new RegExp('('+d.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+e+')','g');a=a.replace(f,'<a href="'+linkProtocol+$.trim(d)+'" class="redactor-linkify-object">'+$.trim(text)+'</a>')}}return a}}},list:function(){return{toggle:function(a){this.placeholder.remove();if(!this.utils.browser('msie')&&!this.opts.linebreaks){this.$editor.focus()}this.buffer.set();this.selection.save();var b=this.selection.getParent();var c=$(b).closest('ol, ul',this.$editor[0]);if(!this.utils.isRedactorParent(c)&&c.length!==0){c=false}var d,isOrderedCmdUnordered;var e=false;if(c&&c.length){e=true;var f=c[0].tagName;d=(a==='orderedlist'&&f==='UL');isOrderedCmdUnordered=(a==='unorderedlist'&&f==='OL')}if(d){this.utils.replaceToTag(c,'ol')}else if(isOrderedCmdUnordered){this.utils.replaceToTag(c,'ul')}else{if(e){this.list.remove(a,c)}else{this.list.insert(a)}}this.selection.restore();this.code.sync()},insert:function(a){var b=this.selection.getCurrent();var c=$(b).closest('td, th',this.$editor[0]);if(this.utils.browser('msie')&&this.opts.linebreaks){this.list.insertInIe(a)}else{document.execCommand('insert'+a)}var d=this.selection.getParent();var e=$(d).closest('ol, ul',this.$editor[0]);if(c.length!==0){var f=c.clone();c.after(f).remove('')}if(this.utils.isEmpty(e.find('li').text())){var g=e.children('li');g.find('br').remove();g.append(this.selection.getMarkerAsHtml());if(this.opts.linebreaks&&this.utils.browser('mozilla')&&g.size()==2&&this.utils.isEmpty(g.eq(1).text())){g.eq(1).remove()}}if(e.length){var h=e.parent();if(this.utils.isRedactorParent(h)&&h[0].tagName!='LI'&&this.utils.isBlock(h[0])){h.replaceWith(h.contents())}}if(!this.utils.browser('msie')){this.$editor.focus()}this.clean.clearUnverified()},insertInIe:function(a){var b=this.selection.wrap('div');var c=$(b).html();var d=(a=='orderedlist')?$('<ol>'):$('<ul>');var e=$('<li>');if($.trim(c)===''){e.append(this.selection.getMarkerAsHtml());d.append(e);this.$editor.find('#selection-marker-1').replaceWith(d)}else{var f=c.split(/<br\s?\/?>/gi);if(f){for(var i=0;i<f.length;i++){if($.trim(f[i])!==''){d.append($('<li>').html(f[i]))}}}else{e.append(c);d.append(e)}$(b).replaceWith(d)}},remove:function(a,b){if($.inArray('ul',this.selection.getBlocks()))a='unorderedlist';document.execCommand('insert'+a);var c=$(this.selection.getCurrent());this.indent.fixEmptyIndent();if(!this.opts.linebreaks&&c.closest('li, th, td',this.$editor[0]).length===0){document.execCommand('formatblock',false,'p');this.$editor.find('ul, ol, blockquote').each($.proxy(this.utils.removeEmpty,this))}var d=$(this.selection.getCurrent()).closest('table',this.$editor[0]);var e=d.prev();if(!this.opts.linebreaks&&d.length!==0&&e.length!==0&&e[0].tagName=='BR'){e.remove()}this.clean.clearUnverified()}}},modal:function(){return{callbacks:{},loadTemplates:function(){this.opts.modal={imageEdit:String()+'<section id="redactor-modal-image-edit">'+'<label>'+this.lang.get('title')+'</label>'+'<input type="text" id="redactor-image-title" />'+'<label class="redactor-image-link-option">'+this.lang.get('link')+'</label>'+'<input type="text" id="redactor-image-link" class="redactor-image-link-option" aria-label="'+this.lang.get('link')+'" />'+'<label class="redactor-image-link-option"><input type="checkbox" id="redactor-image-link-blank" aria-label="'+this.lang.get('link_new_tab')+'"> '+this.lang.get('link_new_tab')+'</label>'+'<label class="redactor-image-position-option">'+this.lang.get('image_position')+'</label>'+'<select class="redactor-image-position-option" id="redactor-image-align" aria-label="'+this.lang.get('image_position')+'">'+'<option value="none">'+this.lang.get('none')+'</option>'+'<option value="left">'+this.lang.get('left')+'</option>'+'<option value="center">'+this.lang.get('center')+'</option>'+'<option value="right">'+this.lang.get('right')+'</option>'+'</select>'+'</section>',image:String()+'<section id="redactor-modal-image-insert">'+'<div id="redactor-modal-image-droparea"></div>'+'</section>',file:String()+'<section id="redactor-modal-file-insert">'+'<div id="redactor-modal-file-upload-box">'+'<label>'+this.lang.get('filename')+'</label>'+'<input type="text" id="redactor-filename" aria-label="'+this.lang.get('filename')+'" /><br><br>'+'<div id="redactor-modal-file-upload"></div>'+'</div>'+'</section>',link:String()+'<section id="redactor-modal-link-insert">'+'<label>URL</label>'+'<input type="url" id="redactor-link-url" aria-label="URL" />'+'<label>'+this.lang.get('text')+'</label>'+'<input type="text" id="redactor-link-url-text" aria-label="'+this.lang.get('text')+'" />'+'<label><input type="checkbox" id="redactor-link-blank"> '+this.lang.get('link_new_tab')+'</label>'+'</section>'};$.extend(this.opts,this.opts.modal);this.focus.setEnd()},addCallback:function(a,b){this.modal.callbacks[a]=b},createTabber:function(a){this.modal.$tabber=$('<div>').attr('id','redactor-modal-tabber');a.prepend(this.modal.$tabber)},addTab:function(a,b,c){var d=$('<a href="#" rel="tab'+a+'">').text(b);if(c){d.addClass('active')}var f=this;d.on('click',function(e){e.preventDefault();$('.redactor-tab').hide();$('.redactor-'+$(this).attr('rel')).show();f.modal.$tabber.find('a').removeClass('active');$(this).addClass('active')});this.modal.$tabber.append(d)},addTemplate:function(a,b){this.opts.modal[a]=b},getTemplate:function(a){return this.opts.modal[a]},getModal:function(){return this.$modalBody.find('section')},load:function(a,b,c){this.modal.templateName=a;this.modal.width=c;this.modal.build();this.modal.enableEvents();this.modal.setTitle(b);this.modal.setDraggable();this.modal.setContent();if(typeof this.modal.callbacks[a]!='undefined'){this.modal.callbacks[a].call(this)}},show:function(){this.utils.disableBodyScroll();if(this.utils.isMobile()){this.modal.showOnMobile()}else{this.modal.showOnDesktop()}if(this.opts.highContrast){this.$modalBox.addClass("redactor-modal-contrast")}this.$modalOverlay.show();this.$modalBox.show();this.$modal.attr('tabindex','-1');this.$modal.focus();this.modal.setButtonsWidth();this.utils.saveScroll();if(!this.utils.isMobile()){setTimeout($.proxy(this.modal.showOnDesktop,this),0);$(window).on('resize.redactor-modal',$.proxy(this.modal.resize,this))}this.core.setCallback('modalOpened',this.modal.templateName,this.$modal);$(document).off('focusin.modal');this.$modal.find('input[type=text],input[type=url],input[type=email]').on('keydown.redactor-modal',$.proxy(this.modal.setEnter,this))},showOnDesktop:function(){var a=this.$modal.outerHeight();var b=$(window).height();var c=$(window).width();if(this.modal.width>c){this.$modal.css({width:'96%',marginTop:(b/2-a/2)+'px'});return}if(a>b){this.$modal.css({width:this.modal.width+'px',marginTop:'20px'})}else{this.$modal.css({width:this.modal.width+'px',marginTop:(b/2-a/2)+'px'})}},showOnMobile:function(){this.$modal.css({width:'96%',marginTop:'2%'})},resize:function(){if(this.utils.isMobile()){this.modal.showOnMobile()}else{this.modal.showOnDesktop()}},setTitle:function(a){this.$modalHeader.html(a)},setContent:function(){this.$modalBody.html(this.modal.getTemplate(this.modal.templateName))},setDraggable:function(){if(typeof $.fn.draggable==='undefined')return;this.$modal.draggable({handle:this.$modalHeader});this.$modalHeader.css('cursor','move')},setEnter:function(e){if(e.which!=13)return;e.preventDefault();this.$modal.find('button.redactor-modal-action-btn').click()},createCancelButton:function(){var a=$('<button>').addClass('redactor-modal-btn redactor-modal-close-btn').html(this.lang.get('cancel'));a.on('click',$.proxy(this.modal.close,this));this.$modalFooter.append(a)},createDeleteButton:function(a){return this.modal.createButton(a,'delete')},createActionButton:function(a){return this.modal.createButton(a,'action')},createButton:function(a,b){var c=$('<button>').addClass('redactor-modal-btn').addClass('redactor-modal-'+b+'-btn').html(a);this.$modalFooter.append(c);return c},setButtonsWidth:function(){var a=this.$modalFooter.find('button');var b=a.length;if(b===0)return;a.css('width',(100/b)+'%')},build:function(){this.modal.buildOverlay();this.$modalBox=$('<div id="redactor-modal-box"/>').hide();this.$modal=$('<div id="redactor-modal" role="dialog" aria-labelledby="redactor-modal-header" />');this.$modalHeader=$('<header id="redactor-modal-header"/>');this.$modalClose=$('<button type="button" id="redactor-modal-close" tabindex="1" aria-label="Close" />').html('&times;');this.$modalBody=$('<div id="redactor-modal-body" />');this.$modalFooter=$('<footer />');this.$modal.append(this.$modalHeader);this.$modal.append(this.$modalClose);this.$modal.append(this.$modalBody);this.$modal.append(this.$modalFooter);this.$modalBox.append(this.$modal);this.$modalBox.appendTo(document.body)},buildOverlay:function(){this.$modalOverlay=$('<div id="redactor-modal-overlay">').hide();$('body').prepend(this.$modalOverlay)},enableEvents:function(){this.$modalClose.on('click.redactor-modal',$.proxy(this.modal.close,this));$(document).on('keyup.redactor-modal',$.proxy(this.modal.closeHandler,this));this.$editor.on('keyup.redactor-modal',$.proxy(this.modal.closeHandler,this));this.$modalBox.on('click.redactor-modal',$.proxy(this.modal.close,this))},disableEvents:function(){this.$modalClose.off('click.redactor-modal');$(document).off('keyup.redactor-modal');this.$editor.off('keyup.redactor-modal');this.$modalBox.off('click.redactor-modal');$(window).off('resize.redactor-modal')},closeHandler:function(e){if(e.which!=this.keyCode.ESC)return;this.modal.close(false)},close:function(e){if(e){if(!$(e.target).hasClass('redactor-modal-close-btn')&&e.target!=this.$modalClose[0]&&e.target!=this.$modalBox[0]){return}e.preventDefault()}if(!this.$modalBox)return;this.modal.disableEvents();this.utils.enableBodyScroll();this.$modalOverlay.remove();this.$modalBox.fadeOut('fast',$.proxy(function(){this.$modalBox.remove();setTimeout($.proxy(this.utils.restoreScroll,this),0);if(e!==undefined)this.selection.restore();$(document.body).css('overflow',this.modal.bodyOveflow);this.core.setCallback('modalClosed',this.modal.templateName)},this))}}},observe:function(){return{load:function(){if(typeof this.opts.destroyed!="undefined")return;if(this.utils.browser('msie')){var a=this;this.$editor.find('pre, code').on('mouseover',function(){a.$editor.attr('contenteditable',false);$(this).attr('contenteditable',true)}).on('mouseout',function(){a.$editor.attr('contenteditable',true);$(this).removeAttr('contenteditable')})}this.observe.images();this.observe.links()},toolbar:function(e,a){this.observe.buttons(e,a);this.observe.dropdowns()},isCurrent:function(a,b){if(typeof b=='undefined'){var b=$(this.selection.getCurrent())}return b.is(a)||b.parents(a).length>0},dropdowns:function(){var d=$(this.selection.getCurrent());$.each(this.opts.observe.dropdowns,$.proxy(function(a,b){var c=b.observe,element=c.element,$item=b.item,inValues=typeof c['in']!='undefined'?c['in']:false,outValues=typeof c['out']!='undefined'?c['out']:false;if(d.closest(element).size()>0){this.observe.setDropdownProperties($item,inValues,outValues)}else{this.observe.setDropdownProperties($item,outValues,inValues)}},this))},setDropdownProperties:function(a,b,c){if(c&&typeof c['attr']!='undefined'){this.observe.setDropdownAttr(a,c.attr,true)}if(typeof b['attr']!='undefined'){this.observe.setDropdownAttr(a,b.attr)}if(typeof b['title']!='undefined'){a.text(b['title'])}},setDropdownAttr:function(c,d,e){$.each(d,function(a,b){if(a=='class'){if(!e){c.addClass(b)}else{c.removeClass(b)}}else{if(!e){c.attr(a,b)}else{c.removeAttr(a)}}})},addDropdown:function(a,b,c){if(typeof c.observe=="undefined")return;c.item=a;this.opts.observe.dropdowns.push(c)},buttons:function(e,f){var g=this.selection.getCurrent();var h=this.selection.getParent();if(e!==false){this.button.setInactiveAll()}else{this.button.setInactiveAll(f)}if(e===false&&f!=='html'){if($.inArray(f,this.opts.activeButtons)!=-1)this.button.toggleActive(f);return}$.each(this.opts.activeButtonsStates,$.proxy(function(a,b){var c=$(h).closest(a,this.$editor[0]);var d=$(g).closest(a,this.$editor[0]);if(c.length!==0&&!this.utils.isRedactorParent(c))return;if(!this.utils.isRedactorParent(d))return;if(c.length!==0||d.closest(a,this.$editor[0]).length!==0){this.button.setActive(b)}},this));var i=$(h).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(this.utils.isRedactorParent(h)&&i.length){var j=(i.css('text-align')==='')?'left':i.css('text-align');this.button.setActive('align'+j)}},addButton:function(a,b){this.opts.activeButtons.push(b);this.opts.activeButtonsStates[a]=b},images:function(){this.$editor.find('img').each($.proxy(function(i,a){var b=$(a);b.closest('a',this.$editor[0]).on('click',function(e){e.preventDefault()});if(this.utils.browser('msie'))b.attr('unselectable','on');this.image.setEditable(b)},this));$(document).on('click.redactor-image-delete.'+this.uuid,$.proxy(function(e){this.observe.image=false;if(e.target.tagName=='IMG'&&this.utils.isRedactorParent(e.target)){this.observe.image=(this.observe.image&&this.observe.image==e.target)?false:e.target}},this))},links:function(){if(!this.opts.linkTooltip)return;this.$editor.find('a').on('touchstart.redactor.'+this.uuid+' click.redactor.'+this.uuid,$.proxy(this.observe.showTooltip,this));this.$editor.on('touchstart.redactor.'+this.uuid+' click.redactor.'+this.uuid,$.proxy(this.observe.closeTooltip,this));$(document).on('touchstart.redactor.'+this.uuid+' click.redactor.'+this.uuid,$.proxy(this.observe.closeTooltip,this))},getTooltipPosition:function(a){return a.offset()},showTooltip:function(e){var a=$(e.target);if(a[0].tagName=='IMG')return;if(a[0].tagName!=='A')a=a.closest('a',this.$editor[0]);if(a[0].tagName!=='A')return;var b=a;var c=this.observe.getTooltipPosition(b);var d=$('<span class="redactor-link-tooltip"></span>');var f=b.attr('href');if(f===undefined){f=''}if(f.length>24)f=f.substring(0,24)+'...';var g=$('<a href="'+b.attr('href')+'" target="_blank" />').html(f).addClass('redactor-link-tooltip-action');var h=$('<a href="#" />').html(this.lang.get('edit')).on('click',$.proxy(this.link.show,this)).addClass('redactor-link-tooltip-action');var i=$('<a href="#" />').html(this.lang.get('unlink')).on('click',$.proxy(this.link.unlink,this)).addClass('redactor-link-tooltip-action');d.append(g).append(' | ').append(h).append(' | ').append(i);d.css({top:(c.top+parseInt(b.css('line-height'),10))+'px',left:c.left+'px'});$('.redactor-link-tooltip').remove();$('body').append(d)},closeTooltip:function(e){e=e.originalEvent||e;var a=e.target;var b=$(a).closest('a',this.$editor[0]);if(b.length!==0&&b[0].tagName==='A'&&a.tagName!=='A'){return}else if((a.tagName==='A'&&this.utils.isRedactorParent(a))||$(a).hasClass('redactor-link-tooltip-action')){return}$('.redactor-link-tooltip').remove()}}},paragraphize:function(){return{load:function(a){if(this.opts.linebreaks)return a;if(a===''||a==='<p></p>')return this.opts.emptyHtml;a=a+"\n";this.paragraphize.safes=[];this.paragraphize.z=0;a=a.replace(/(<br\s?\/?>){1,}\n?<\/blockquote>/gi,'</blockquote>');a=this.paragraphize.getSafes(a);a=this.paragraphize.getSafesComments(a);a=this.paragraphize.replaceBreaksToNewLines(a);a=this.paragraphize.replaceBreaksToParagraphs(a);a=this.paragraphize.clear(a);a=this.paragraphize.restoreSafes(a);a=a.replace(new RegExp('<br\\s?/?>\n?<('+this.opts.paragraphizeBlocks.join('|')+')(.*?[^>])>','gi'),'<p><br /></p>\n<$1$2>');return $.trim(a)},getSafes:function(a){var b=$('<div />').append(a);b.find('blockquote p').replaceWith(function(){return $(this).append('<br />').contents()});a=b.html();b.find(this.opts.paragraphizeBlocks.join(', ')).each($.proxy(function(i,s){this.paragraphize.z++;this.paragraphize.safes[this.paragraphize.z]=s.outerHTML;a=a.replace(s.outerHTML,'\n{replace'+this.paragraphize.z+'}')},this));return a},getSafesComments:function(a){var b=a.match(/<!--([\w\W]*?)-->/gi);if(!b)return a;$.each(b,$.proxy(function(i,s){this.paragraphize.z++;this.paragraphize.safes[this.paragraphize.z]=s;a=a.replace(s,'\n{replace'+this.paragraphize.z+'}')},this));return a},restoreSafes:function(a){$.each(this.paragraphize.safes,function(i,s){s=(typeof s!=='undefined')?s.replace(/\$/g,'&#36;'):s;a=a.replace('{replace'+i+'}',s)});return a},replaceBreaksToParagraphs:function(a){var b=a.split(new RegExp('\n','g'),-1);a='';if(b){var c=b.length;for(var i=0;i<c;i++){if(!b.hasOwnProperty(i))return;if(b[i].search('{replace')==-1){b[i]=b[i].replace(/<p>\n\t?<\/p>/gi,'');b[i]=b[i].replace(/<p><\/p>/gi,'');if(b[i]!==''){a+='<p>'+b[i].replace(/^\n+|\n+$/g,"")+"</p>"}}else a+=b[i]}}return a},replaceBreaksToNewLines:function(a){a=a.replace(/<br \/>\s*<br \/>/gi,"\n\n");a=a.replace(/<br\s?\/?>\n?<br\s?\/?>/gi,"\n<br /><br />");a=a.replace(new RegExp("\r\n",'g'),"\n");a=a.replace(new RegExp("\r",'g'),"\n");a=a.replace(new RegExp("/\n\n+/"),'g',"\n\n");return a},clear:function(a){a=a.replace(new RegExp('</blockquote></p>','gi'),'</blockquote>');a=a.replace(new RegExp('<p></blockquote>','gi'),'</blockquote>');a=a.replace(new RegExp('<p><blockquote>','gi'),'<blockquote>');a=a.replace(new RegExp('<blockquote></p>','gi'),'<blockquote>');a=a.replace(new RegExp('<p><p ','gi'),'<p ');a=a.replace(new RegExp('<p><p>','gi'),'<p>');a=a.replace(new RegExp('</p></p>','gi'),'</p>');a=a.replace(new RegExp('<p>\\s?</p>','gi'),'');a=a.replace(new RegExp("\n</p>",'gi'),'</p>');a=a.replace(new RegExp('<p>\t?\t?\n?<p>','gi'),'<p>');a=a.replace(new RegExp('<p>\t*</p>','gi'),'');return a}}},paste:function(){return{init:function(e){if(!this.opts.cleanOnPaste){setTimeout($.proxy(this.code.sync,this),1);return}this.rtePaste=true;this.buffer.set();this.selection.save();this.utils.saveScroll();this.paste.createPasteBox();$(window).on('scroll.redactor-freeze',$.proxy(function(){$(window).scrollTop(this.saveBodyScroll)},this));setTimeout($.proxy(function(){var a=this.$pasteBox.html();this.$pasteBox.remove();this.selection.restore();this.utils.restoreScroll();this.paste.insert(a);$(window).off('scroll.redactor-freeze');if(this.linkify.isEnabled()){this.linkify.format()}},this),1)},createPasteBox:function(){this.$pasteBox=$('<div>').html('').attr('contenteditable','true').css({position:'fixed',width:0,top:0,left:'-9999px'});if(this.utils.browser('msie')){this.$box.append(this.$pasteBox)}else{var a=$('.modal-body:visible');if(a.length>0){a.append(this.$pasteBox)}else{$('body').append(this.$pasteBox)}}this.$pasteBox.get(0).focus()},insert:function(c){c=this.core.setCallback('pasteBefore',c);c=(this.utils.isSelectAll())?this.clean.onPaste(c,false):this.clean.onPaste(c);c=this.core.setCallback('paste',c);if(this.utils.isSelectAll()){this.insert.set(c,false)}else{this.insert.html(c,false)}this.utils.disableSelectAll();this.rtePaste=false;setTimeout($.proxy(this.clean.clearUnverified,this),10);setTimeout($.proxy(function(){var b=this.$editor.find('span');$.each(b,function(i,s){var a=s.innerHTML.replace(/\u200B/,'');if(a===''&&s.attributes.length===0)$(s).remove()})},this),10)}}},placeholder:function(){return{enable:function(){if(!this.placeholder.is())return;this.$editor.attr('placeholder',this.$element.attr('placeholder'));this.placeholder.toggle();this.$editor.on('keyup.redactor-placeholder',$.proxy(this.placeholder.toggle,this))},toggle:function(){setTimeout($.proxy(function(){var a=this.utils.isEmpty(this.$editor.html(),false)?'addClass':'removeClass';this.$editor[a]('redactor-placeholder')},this),5)},remove:function(){this.$editor.removeClass('redactor-placeholder')},is:function(){if(this.opts.placeholder){return this.$element.attr('placeholder',this.opts.placeholder)}else{return!(typeof this.$element.attr('placeholder')=='undefined'||this.$element.attr('placeholder')==='')}}}},progress:function(){return{show:function(){$(document.body).append($('<div id="redactor-progress"><span></span></div>'));$('#redactor-progress').fadeIn()},hide:function(){$('#redactor-progress').fadeOut(1500,function(){$(this).remove()})}}},selection:function(){return{get:function(){this.sel=document.getSelection();if(document.getSelection&&this.sel.getRangeAt&&this.sel.rangeCount){this.range=this.sel.getRangeAt(0)}else{this.range=document.createRange()}},addRange:function(){try{this.sel.removeAllRanges()}catch(e){}this.sel.addRange(this.range)},getCurrent:function(){var a=false;this.selection.get();if(this.sel&&this.sel.rangeCount>0){a=this.sel.getRangeAt(0).startContainer}return this.utils.isRedactorParent(a)},getParent:function(a){a=a||this.selection.getCurrent();if(a){return this.utils.isRedactorParent($(a).parent()[0])}return false},getPrev:function(){return window.getSelection().anchorNode.previousSibling},getNext:function(){return window.getSelection().anchorNode.nextSibling},getBlock:function(a){a=a||this.selection.getCurrent();while(a){if(this.utils.isBlockTag(a.tagName)){return($(a).hasClass('redactor-editor'))?false:a}a=a.parentNode}return false},getInlines:function(b,c){this.selection.get();if(this.range&&this.range.collapsed){return false}var d=[];b=(typeof b=='undefined'||b===false)?this.selection.getNodes():b;var e=this.opts.inlineTags;e.push('span');if(typeof c!=='undefined'){for(var i=0;i<c.length;i++){e.push(c[i])}}$.each(b,$.proxy(function(i,a){if($.inArray(a.tagName.toLowerCase(),e)!=-1){d.push(a)}},this));return(d.length===0)?false:d},getInlinesTags:function(b){this.selection.get();if(this.range&&this.range.collapsed){return false}var c=[];var d=this.selection.getNodes();$.each(d,$.proxy(function(i,a){if($.inArray(a.tagName.toLowerCase(),b)!=-1){c.push(a)}},this));return(c.length===0)?false:c},getBlocks:function(b){this.selection.get();if(this.range&&this.range.collapsed){return[this.selection.getBlock()]}var c=[];b=(typeof b=='undefined')?this.selection.getNodes():b;$.each(b,$.proxy(function(i,a){if(this.utils.isBlock(a)){c.push(a)}},this));return(c.length===0)?[this.selection.getBlock()]:c},getLastBlock:function(){return this.selection.lastBlock},getNodes:function(){this.selection.get();var b=this.selection.getNodesMarker(1);var c=this.selection.getNodesMarker(2);if(this.range.collapsed===false){if(window.getSelection){var d=window.getSelection();if(d.rangeCount>0){var e=d.getRangeAt(0);var f=e.startContainer,startOffset=e.startOffset;var g=e.cloneRange();g.collapse(false);g.insertNode(c);g.setStart(f,startOffset);g.collapse(true);g.insertNode(b);e.setStartAfter(b);e.setEndBefore(c);d.removeAllRanges();d.addRange(e)}}}else{this.selection.setNodesMarker(this.range,b,true);c=b}var h=[];var j=0;var k=this;this.$editor.find('*').each(function(){if(this==b){var a=$(this).parent();if(a.length!==0&&a[0].tagName!='BODY'&&k.utils.isRedactorParent(a[0])){h.push(a[0])}h.push(this);j=1}else{if(j>0){h.push(this);j=j+1}}if(this==c){return false}});var l=[];var m=h.length;for(var i=0;i<m;i++){if(h[i].id!='nodes-marker-1'&&h[i].id!='nodes-marker-2'){l.push(h[i])}}this.selection.removeNodesMarkers();return l},getNodesMarker:function(a){return $('<span id="nodes-marker-'+a+'" class="redactor-nodes-marker" data-verified="redactor">'+this.opts.invisibleSpace+'</span>')[0]},setNodesMarker:function(a,b,c){var a=a.cloneRange();try{a.collapse(c);a.insertNode(b)}catch(e){}},removeNodesMarkers:function(){$(document).find('span.redactor-nodes-marker').remove();this.$editor.find('span.redactor-nodes-marker').remove()},fromPoint:function(a,b){this.caret.setOffset(a,b)},wrap:function(a){this.selection.get();if(this.range.collapsed)return false;var b=document.createElement(a);b.appendChild(this.range.extractContents());this.range.insertNode(b);return b},selectElement:function(a){if(this.utils.browser('mozilla')){a=a[0]||a;var b=document.createRange();b.selectNodeContents(a)}else{this.caret.set(a,0,a,1)}},selectAll:function(){this.selection.get();this.range.selectNodeContents(this.$editor[0]);this.selection.addRange()},remove:function(){this.selection.get();this.sel.removeAllRanges()},save:function(){this.selection.createMarkers()},createMarkers:function(){this.selection.get();var a=this.selection.getMarker(1);this.selection.setMarker(this.range,a,true);if(this.range.collapsed===false){var b=this.selection.getMarker(2);this.selection.setMarker(this.range,b,false)}this.savedSel=this.$editor.html()},getMarker:function(a){if(typeof a=='undefined')a=1;return $('<span id="selection-marker-'+a+'" class="redactor-selection-marker"  data-verified="redactor">'+this.opts.invisibleSpace+'</span>')[0]},getMarkerAsHtml:function(a){return this.utils.getOuterHtml(this.selection.getMarker(a))},setMarker:function(a,b,c){a=a.cloneRange();try{a.collapse(c);a.insertNode(b)}catch(e){this.focus.setStart()}},restore:function(){var a=this.$editor.find('span#selection-marker-1');var b=this.$editor.find('span#selection-marker-2');if(this.utils.browser('mozilla')){this.$editor.focus()}if(a.length!==0&&b.length!==0){this.caret.set(a,0,b,0)}else if(a.length!==0){this.caret.set(a,0,a,0)}else{this.$editor.focus()}this.selection.removeMarkers();this.savedSel=false},removeMarkers:function(){this.$editor.find('span.redactor-selection-marker').each(function(i,s){var a=$(s).text().replace(/\u200B/g,'');if(a==='')$(s).remove();else $(s).replaceWith(function(){return $(this).contents()})})},getText:function(){this.selection.get();return this.sel.toString()},getHtml:function(){var a='';this.selection.get();if(this.sel.rangeCount){var b=document.createElement('div');var c=this.sel.rangeCount;for(var i=0;i<c;++i){b.appendChild(this.sel.getRangeAt(i).cloneContents())}a=b.innerHTML}return this.clean.onSync(a)},replaceSelection:function(a){this.selection.get();this.range.deleteContents();var b=document.createElement("div");b.innerHTML=a;var c=document.createDocumentFragment(),child;while((child=b.firstChild)){c.appendChild(child)}this.range.insertNode(c)},replaceWithHtml:function(a){a=this.selection.getMarkerAsHtml(1)+a+this.selection.getMarkerAsHtml(2);this.selection.get();if(window.getSelection&&window.getSelection().getRangeAt){this.selection.replaceSelection(a)}else if(document.selection&&document.selection.createRange){this.range.pasteHTML(a)}this.selection.restore();this.code.sync()}}},shortcuts:function(){return{init:function(e,g){if(!this.opts.shortcuts){if((e.ctrlKey||e.metaKey)&&(g===66||g===73))e.preventDefault();return false}$.each(this.opts.shortcuts,$.proxy(function(b,c){var d=b.split(',');var f=d.length;for(var i=0;i<f;i++){if(typeof d[i]==='string'){this.shortcuts.handler(e,$.trim(d[i]),$.proxy(function(){var a;if(c.func.search(/\./)!='-1'){a=c.func.split('.');if(typeof this[a[0]]!='undefined'){this[a[0]][a[1]].apply(this,c.params)}}else{this[c.func].apply(this,c.params)}},this))}}},this))},handler:function(e,c,d){var f={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};var g={"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":"\"",",":"<",".":">","/":"?","\\":"|"};c=c.toLowerCase().split(" ");var h=f[e.keyCode],character=String.fromCharCode(e.which).toLowerCase(),modif="",possible={};$.each(["alt","ctrl","meta","shift"],function(a,b){if(e[b+'Key']&&h!==b){modif+=b+'+'}});if(h)possible[modif+h]=true;if(character){possible[modif+character]=true;possible[modif+g[character]]=true;if(modif==="shift+"){possible[g[character]]=true}}for(var i=0,len=c.length;i<len;i++){if(possible[c[i]]){e.preventDefault();return d.apply(this,arguments)}}}}},tabifier:function(){return{get:function(a){if(!this.opts.tabifier)return a;var b=['area','body','head','hr','i?frame','link','meta','noscript','style','script','table','tbody','thead','tfoot'];var c=['li','dt','dt','h[1-6]','option','script'];var d=['p','blockquote','div','dl','fieldset','form','frameset','map','ol','pre','select','td','th','tr','ul'];this.tabifier.lineBefore=new RegExp('^<(/?'+b.join('|/?')+'|'+c.join('|')+')[ >]');this.tabifier.lineAfter=new RegExp('^<(br|/?'+b.join('|/?')+'|/'+c.join('|/')+')[ >]');this.tabifier.newLevel=new RegExp('^</?('+d.join('|')+')[ >]');var i=0,codeLength=a.length,point=0,start=null,end=null,tag='',out='',cont='';this.tabifier.cleanlevel=0;for(;i<codeLength;i++){point=i;if(-1==a.substr(i).indexOf('<')){out+=a.substr(i);return this.tabifier.finish(out)}while(point<codeLength&&a.charAt(point)!='<'){point++}if(i!=point){cont=a.substr(i,point-i);if(!cont.match(/^\s{2,}$/g)){if('\n'==out.charAt(out.length-1))out+=this.tabifier.getTabs();else if('\n'==cont.charAt(0)){out+='\n'+this.tabifier.getTabs();cont=cont.replace(/^\s+/,'')}out+=cont}if(cont.match(/\n/))out+='\n'+this.tabifier.getTabs()}start=point;while(point<codeLength&&'>'!=a.charAt(point)){point++}tag=a.substr(start,point-start);i=point;var t;if('!--'==tag.substr(1,3)){if(!tag.match(/--$/)){while('-->'!=a.substr(point,3)){point++}point+=2;tag=a.substr(start,point-start);i=point}if('\n'!=out.charAt(out.length-1))out+='\n';out+=this.tabifier.getTabs();out+=tag+'>\n'}else if('!'==tag[1]){out=this.tabifier.placeTag(tag+'>',out)}else if('?'==tag[1]){out+=tag+'>\n'}else if(t=tag.match(/^<(script|style|pre)/i)){t[1]=t[1].toLowerCase();tag=this.tabifier.cleanTag(tag);out=this.tabifier.placeTag(tag,out);end=String(a.substr(i+1)).toLowerCase().indexOf('</'+t[1]);if(end){cont=a.substr(i+1,end);i+=end;out+=cont}}else{tag=this.tabifier.cleanTag(tag);out=this.tabifier.placeTag(tag,out)}}return this.tabifier.finish(out)},getTabs:function(){var s='';for(var j=0;j<this.tabifier.cleanlevel;j++){s+='\t'}return s},finish:function(a){a=a.replace(/\n\s*\n/g,'\n');a=a.replace(/^[\s\n]*/,'');a=a.replace(/[\s\n]*$/,'');a=a.replace(/<script(.*?)>\n<\/script>/gi,'<script$1></script>');this.tabifier.cleanlevel=0;return a},cleanTag:function(a){var b='';a=a.replace(/\n/g,' ');a=a.replace(/\s{2,}/g,' ');a=a.replace(/^\s+|\s+$/g,' ');var c='';if(a.match(/\/$/)){c='/';a=a.replace(/\/+$/,'')}var m;while(m=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(a)){if(m[2])b+=m[1].toLowerCase()+'='+m[2];else if(m[1])b+=m[1].toLowerCase();b+=' ';a=a.substr(m[0].length)}return b.replace(/\s*$/,'')+c+'>'},placeTag:function(a,b){var c=a.match(this.tabifier.newLevel);if(a.match(this.tabifier.lineBefore)||c){b=b.replace(/\s*$/,'');b+='\n'}if(c&&'/'==a.charAt(1))this.tabifier.cleanlevel--;if('\n'==b.charAt(b.length-1))b+=this.tabifier.getTabs();if(c&&'/'!=a.charAt(1))this.tabifier.cleanlevel++;b+=a;if(a.match(this.tabifier.lineAfter)||a.match(this.tabifier.newLevel)){b=b.replace(/ *$/,'')}return b}}},tidy:function(){return{setupAllowed:function(){var a=$.inArray('span',this.opts.removeEmpty);if(a!==-1){this.opts.removeEmpty.splice(a,1)}if(this.opts.allowedTags)this.opts.deniedTags=false;if(this.opts.allowedAttr)this.opts.removeAttr=false;if(this.opts.linebreaks)return;var b=['p','section'];if(this.opts.allowedTags)this.tidy.addToAllowed(b);if(this.opts.deniedTags)this.tidy.removeFromDenied(b)},addToAllowed:function(a){var b=a.length;for(var i=0;i<b;i++){if($.inArray(a[i],this.opts.allowedTags)==-1){this.opts.allowedTags.push(a[i])}}},removeFromDenied:function(a){var b=a.length;for(var i=0;i<b;i++){var c=$.inArray(a[i],this.opts.deniedTags);if(c!=-1){this.opts.deniedTags.splice(c,1)}}},load:function(a,b){this.tidy.settings={deniedTags:this.opts.deniedTags,allowedTags:this.opts.allowedTags,removeComments:this.opts.removeComments,replaceTags:this.opts.replaceTags,replaceStyles:this.opts.replaceStyles,removeDataAttr:this.opts.removeDataAttr,removeAttr:this.opts.removeAttr,allowedAttr:this.opts.allowedAttr,removeWithoutAttr:this.opts.removeWithoutAttr,removeEmpty:this.opts.removeEmpty};$.extend(this.tidy.settings,b);a=this.tidy.removeComments(a);this.tidy.$div=$('<div />').append(a);this.tidy.replaceTags();this.tidy.replaceStyles();this.tidy.removeTags();this.tidy.removeAttr();this.tidy.removeEmpty();this.tidy.removeParagraphsInLists();this.tidy.removeDataAttr();this.tidy.removeWithoutAttr();a=this.tidy.$div.html();this.tidy.$div.remove();return a},removeComments:function(a){if(!this.tidy.settings.removeComments)return a;return a.replace(/<!--[\s\S]*?-->/gi,'')},replaceTags:function(c){if(!this.tidy.settings.replaceTags)return c;var d=this.tidy.settings.replaceTags.length;var e=[],rTags=[];for(var i=0;i<d;i++){rTags.push(this.tidy.settings.replaceTags[i][1]);e.push(this.tidy.settings.replaceTags[i][0])}$.each(e,$.proxy(function(a,b){this.tidy.$div.find(b).replaceWith(function(){return $("<"+rTags[a]+" />",{html:$(this).html()})})},this))},replaceStyles:function(){if(!this.tidy.settings.replaceStyles)return;var e=this.tidy.settings.replaceStyles.length;this.tidy.$div.find('span').each($.proxy(function(n,s){var b=$(s);var c=b.attr('style');for(var i=0;i<e;i++){if(c&&c.match(new RegExp('^'+this.tidy.settings.replaceStyles[i][0],'i'))){var d=this.tidy.settings.replaceStyles[i][1];b.replaceWith(function(){var a=document.createElement(d);return $(a).append($(this).contents())})}}},this))},removeTags:function(){if(!this.tidy.settings.deniedTags&&this.tidy.settings.allowedTags){this.tidy.$div.find('*').not(this.tidy.settings.allowedTags.join(',')).each(function(i,s){if(s.innerHTML==='')$(s).remove();else $(s).contents().unwrap()})}if(this.tidy.settings.deniedTags){this.tidy.$div.find(this.tidy.settings.deniedTags.join(',')).each(function(i,s){if($(s).hasClass('redactor-script-tag')||$(s).hasClass('redactor-selection-marker'))return;if(s.innerHTML==='')$(s).remove();else $(s).contents().unwrap()})}},removeAttr:function(){var d;if(!this.tidy.settings.removeAttr&&this.tidy.settings.allowedAttr){var e=[],allowedAttrData=[];d=this.tidy.settings.allowedAttr.length;for(var i=0;i<d;i++){e.push(this.tidy.settings.allowedAttr[i][0]);allowedAttrData.push(this.tidy.settings.allowedAttr[i][1])}this.tidy.$div.find('*').each($.proxy(function(n,s){var a=$(s);var b=$.inArray(a[0].tagName.toLowerCase(),e);var c=this.tidy.removeAttrGetRemoves(b,allowedAttrData,a);if(c){$.each(c,function(z,f){a.removeAttr(f)})}},this))}if(this.tidy.settings.removeAttr){d=this.tidy.settings.removeAttr.length;for(var i=0;i<d;i++){var g=this.tidy.settings.removeAttr[i][1];if($.isArray(g))g=g.join(' ');this.tidy.$div.find(this.tidy.settings.removeAttr[i][0]).removeAttr(g)}}},removeAttrGetRemoves:function(b,c,d){var e=[];if(b==-1){$.each(d[0].attributes,function(i,a){e.push(a.name)})}else if(c[b]=='*'){e=[]}else{$.each(d[0].attributes,function(i,a){if($.isArray(c[b])){if($.inArray(a.name,c[b])==-1){e.push(a.name)}}else if(c[b]!=a.name){e.push(a.name)}})}return e},removeAttrs:function(d,e){e=new RegExp(e,"g");return d.each(function(){var a=$(this);var b=this.attributes.length-1;for(var i=b;i>=0;i--){var c=this.attributes[i];if(c&&c.specified&&c.name.search(e)>=0){a.removeAttr(c.name)}}})},removeEmpty:function(){if(!this.tidy.settings.removeEmpty)return;this.tidy.$div.find(this.tidy.settings.removeEmpty.join(',')).each(function(){var a=$(this);var b=a.text();b=b.replace(/\u200B/g,'');b=b.replace(/&nbsp;/gi,'');b=b.replace(/\s/g,'');if(b===''&&a.children().length===0){a.remove()}})},removeParagraphsInLists:function(){this.tidy.$div.find('li p').contents().unwrap()},removeDataAttr:function(){if(!this.tidy.settings.removeDataAttr)return;var a=this.tidy.settings.removeDataAttr;if($.isArray(this.tidy.settings.removeDataAttr))a=this.tidy.settings.removeDataAttr.join(',');this.tidy.removeAttrs(this.tidy.$div.find(a),'^(data-)')},removeWithoutAttr:function(){if(!this.tidy.settings.removeWithoutAttr)return;this.tidy.$div.find(this.tidy.settings.removeWithoutAttr.join(',')).each(function(){if(this.attributes.length===0){$(this).contents().unwrap()}})}}},toolbar:function(){return{init:function(){return{html:{title:this.lang.get('html'),func:'code.toggle'},formatting:{title:this.lang.get('formatting'),dropdown:{p:{title:this.lang.get('paragraph'),func:'block.format'},blockquote:{title:this.lang.get('quote'),func:'block.format'},pre:{title:this.lang.get('code'),func:'block.format'},h1:{title:this.lang.get('header1'),func:'block.format'},h2:{title:this.lang.get('header2'),func:'block.format'},h3:{title:this.lang.get('header3'),func:'block.format'},h4:{title:this.lang.get('header4'),func:'block.format'},h5:{title:this.lang.get('header5'),func:'block.format'}}},bold:{title:this.lang.get('bold'),func:'inline.format'},italic:{title:this.lang.get('italic'),func:'inline.format'},deleted:{title:this.lang.get('deleted'),func:'inline.format'},underline:{title:this.lang.get('underline'),func:'inline.format'},unorderedlist:{title:'&bull; '+this.lang.get('unorderedlist'),func:'list.toggle'},orderedlist:{title:'1. '+this.lang.get('orderedlist'),func:'list.toggle'},outdent:{title:'< '+this.lang.get('outdent'),func:'indent.decrease'},indent:{title:'> '+this.lang.get('indent'),func:'indent.increase'},image:{title:this.lang.get('image'),func:'image.show'},file:{title:this.lang.get('file'),func:'file.show'},link:{title:this.lang.get('link'),dropdown:{link:{title:this.lang.get('link_insert'),func:'link.show',observe:{element:'a',in:{title:this.lang.get('link_edit'),},out:{title:this.lang.get('link_insert')}}},unlink:{title:this.lang.get('unlink'),func:'link.unlink',observe:{element:'a',out:{attr:{'class':'redactor-dropdown-link-inactive','aria-disabled':true}}}}}},alignment:{title:this.lang.get('alignment'),dropdown:{left:{title:this.lang.get('align_left'),func:'alignment.left'},center:{title:this.lang.get('align_center'),func:'alignment.center'},right:{title:this.lang.get('align_right'),func:'alignment.right'},justify:{title:this.lang.get('align_justify'),func:'alignment.justify'}}},horizontalrule:{title:this.lang.get('horizontalrule'),func:'line.insert'}}},build:function(){this.toolbar.hideButtons();this.toolbar.hideButtonsOnMobile();this.toolbar.isButtonSourceNeeded();if(this.opts.buttons.length===0)return;this.$toolbar=this.toolbar.createContainer();this.toolbar.setOverflow();this.toolbar.append();this.toolbar.setFormattingTags();this.toolbar.loadButtons();this.toolbar.setFixed();if(this.opts.activeButtons){this.$editor.on('mouseup.redactor keyup.redactor focus.redactor',$.proxy(this.observe.toolbar,this))}},createContainer:function(){return $('<ul>').addClass('redactor-toolbar').attr({'id':'redactor-toolbar-'+this.uuid,'role':'toolbar'})},setFormattingTags:function(){$.each(this.opts.toolbar.formatting.dropdown,$.proxy(function(i,s){if($.inArray(i,this.opts.formatting)==-1)delete this.opts.toolbar.formatting.dropdown[i]},this))},loadButtons:function(){$.each(this.opts.buttons,$.proxy(function(i,a){if(!this.opts.toolbar[a])return;if(a==='file'){if(this.opts.fileUpload===false)return;else if(!this.opts.fileUpload&&this.opts.s3===false)return}if(a==='image'){if(this.opts.imageUpload===false)return;else if(!this.opts.imageUpload&&this.opts.s3===false)return}var b=this.opts.toolbar[a];this.$toolbar.append($('<li>').append(this.button.build(a,b)))},this))},append:function(){if(this.opts.toolbarExternal){this.$toolbar.addClass('redactor-toolbar-external');$(this.opts.toolbarExternal).html(this.$toolbar)}else{this.$box.prepend(this.$toolbar)}},setFixed:function(){if(!this.utils.isDesktop())return;if(this.opts.toolbarExternal)return;if(!this.opts.toolbarFixed)return;this.toolbar.observeScroll();$(this.opts.toolbarFixedTarget).on('scroll.redactor.'+this.uuid,$.proxy(this.toolbar.observeScroll,this))},setOverflow:function(){if(this.utils.isMobile()&&this.opts.toolbarOverflow){this.$toolbar.addClass('redactor-toolbar-overflow')}},isButtonSourceNeeded:function(){if(this.opts.source)return;var a=this.opts.buttons.indexOf('html');if(a!==-1){this.opts.buttons.splice(a,1)}},hideButtons:function(){if(this.opts.buttonsHide.length===0)return;$.each(this.opts.buttonsHide,$.proxy(function(i,s){var a=this.opts.buttons.indexOf(s);this.opts.buttons.splice(a,1)},this))},hideButtonsOnMobile:function(){if(!this.utils.isMobile()||this.opts.buttonsHideOnMobile.length===0)return;$.each(this.opts.buttonsHideOnMobile,$.proxy(function(i,s){var a=this.opts.buttons.indexOf(s);this.opts.buttons.splice(a,1)},this))},observeScroll:function(){var a=$(this.opts.toolbarFixedTarget).scrollTop();var b=1;if(this.opts.toolbarFixedTarget===document){b=this.$box.offset().top}if((a+this.opts.toolbarFixedTopOffset)>b){this.toolbar.observeScrollEnable(a,b)}else{this.toolbar.observeScrollDisable()}},observeScrollEnable:function(a,b){var c=this.opts.toolbarFixedTopOffset+a-b;var d=0;var e=b+this.$box.height()-32;var f=this.$box.innerWidth();this.$toolbar.addClass('toolbar-fixed-box');this.$toolbar.css({position:'absolute',width:f,top:c+'px',left:d});if(a>e)$('.redactor-dropdown-'+this.uuid+':visible').hide();this.toolbar.setDropdownsFixed();this.$toolbar.css('visibility',(a<e)?'visible':'hidden')},observeScrollDisable:function(){this.$toolbar.css({position:'relative',width:'auto',top:0,left:0,visibility:'visible'});this.toolbar.unsetDropdownsFixed();this.$toolbar.removeClass('toolbar-fixed-box')},setDropdownsFixed:function(){var a=this.$toolbar.innerHeight()+this.opts.toolbarFixedTopOffset;var b='fixed';if(this.opts.toolbarFixedTarget!==document){a=(this.$toolbar.innerHeight()+this.$toolbar.offset().top)+this.opts.toolbarFixedTopOffset;b='absolute'}$('.redactor-dropdown-'+this.uuid).each(function(){$(this).css({position:b,top:a+'px'})})},unsetDropdownsFixed:function(){var a=(this.$toolbar.innerHeight()+this.$toolbar.offset().top);$('.redactor-dropdown-'+this.uuid).each(function(){$(this).css({position:'absolute',top:a+'px'})})}}},upload:function(){return{init:function(a,b,c){this.upload.direct=false;this.upload.callback=c;this.upload.url=b;this.upload.$el=$(a);this.upload.$droparea=$('<div id="redactor-droparea" />');this.upload.$placeholdler=$('<div id="redactor-droparea-placeholder" />').text(this.lang.get('upload_label'));this.upload.$input=$('<input type="file" name="file" />');this.upload.$placeholdler.append(this.upload.$input);this.upload.$droparea.append(this.upload.$placeholdler);this.upload.$el.append(this.upload.$droparea);this.upload.$droparea.off('redactor.upload');this.upload.$input.off('redactor.upload');this.upload.$droparea.on('dragover.redactor.upload',$.proxy(this.upload.onDrag,this));this.upload.$droparea.on('dragleave.redactor.upload',$.proxy(this.upload.onDragLeave,this));this.upload.$input.on('change.redactor.upload',$.proxy(function(e){e=e.originalEvent||e;this.upload.traverseFile(this.upload.$input[0].files[0],e)},this));this.upload.$droparea.on('drop.redactor.upload',$.proxy(function(e){e.preventDefault();this.upload.$droparea.removeClass('drag-hover').addClass('drag-drop');this.upload.onDrop(e)},this))},directUpload:function(a,e){this.upload.direct=true;this.upload.traverseFile(a,e)},onDrop:function(e){e=e.originalEvent||e;var a=e.dataTransfer.files;this.upload.traverseFile(a[0],e)},traverseFile:function(a,e){if(this.opts.s3){this.upload.setConfig(a);this.upload.s3uploadFile(a);return}var b=!!window.FormData?new FormData():null;if(window.FormData){this.upload.setConfig(a);var c=(this.upload.type=='image')?this.opts.imageUploadParam:this.opts.fileUploadParam;b.append(c,a)}this.progress.show();this.core.setCallback('uploadStart',e,b);this.upload.sendData(b,e)},setConfig:function(a){this.upload.getType(a);if(this.upload.direct){this.upload.url=(this.upload.type=='image')?this.opts.imageUpload:this.opts.fileUpload;this.upload.callback=(this.upload.type=='image')?this.image.insert:this.file.insert}},getType:function(a){this.upload.type='image';if(this.opts.imageTypes.indexOf(a.type)==-1){this.upload.type='file'}},getHiddenFields:function(a,b){if(a===false||typeof a!=='object')return b;$.each(a,$.proxy(function(k,v){if(v!==null&&v.toString().indexOf('#')===0)v=$(v).val();b.append(k,v)},this));return b},sendData:function(c,e){if(this.upload.type=='image'){c=this.upload.getHiddenFields(this.opts.uploadImageFields,c);c=this.upload.getHiddenFields(this.upload.imageFields,c)}else{c=this.upload.getHiddenFields(this.opts.uploadFileFields,c);c=this.upload.getHiddenFields(this.upload.fileFields,c)}var d=new XMLHttpRequest();d.open('POST',this.upload.url);d.setRequestHeader("X-Requested-With","XMLHttpRequest");d.onreadystatechange=$.proxy(function(){if(d.readyState==4){var a=d.responseText;a=a.replace(/^\[/,'');a=a.replace(/\]$/,'');var b;try{b=(typeof a==='string'?$.parseJSON(a):a)}catch(err){b={error:true}}this.progress.hide();if(!this.upload.direct){this.upload.$droparea.removeClass('drag-drop')}this.upload.callback(b,this.upload.direct,e)}},this);d.send(c)},onDrag:function(e){e.preventDefault();this.upload.$droparea.addClass('drag-hover')},onDragLeave:function(e){e.preventDefault();this.upload.$droparea.removeClass('drag-hover')},clearImageFields:function(){this.upload.imageFields={}},addImageFields:function(a,b){this.upload.imageFields[a]=b},removeImageFields:function(a){delete this.upload.imageFields[a]},clearFileFields:function(){this.upload.fileFields={}},addFileFields:function(a,b){this.upload.fileFields[a]=b},removeFileFields:function(a){delete this.upload.fileFields[a]},s3uploadFile:function(b){this.upload.s3executeOnSignedUrl(b,$.proxy(function(a){this.upload.s3uploadToS3(b,a)},this))},s3executeOnSignedUrl:function(a,b){var c=new XMLHttpRequest();var d=(this.opts.s3.search(/\?/)!=='-1')?'?':'&';c.open('GET',this.opts.s3+d+'name='+a.name+'&type='+a.type,true);if(c.overrideMimeType)c.overrideMimeType('text/plain; charset=x-user-defined');var f=this;c.onreadystatechange=function(e){if(this.readyState==4&&this.status==200){f.progress.show();b(decodeURIComponent(this.responseText))}else if(this.readyState==4&&this.status!=200){}};c.send()},s3createCORSRequest:function(a,b){var c=new XMLHttpRequest();if("withCredentials"in c){c.open(a,b,true)}else if(typeof XDomainRequest!="undefined"){c=new XDomainRequest();c.open(a,b)}else{c=null}return c},s3uploadToS3:function(d,f){var g=this.upload.s3createCORSRequest('PUT',f);if(!g){}else{g.onload=$.proxy(function(){if(g.status==200){this.progress.hide();var a=f.split('?');if(!a[0]){return false}if(!this.upload.direct){this.upload.$droparea.removeClass('drag-drop')}var b={filelink:a[0]};if(this.upload.type=='file'){var c=a[0].split('/');b.filename=c[c.length-1]}this.upload.callback(b,this.upload.direct,false)}else{}},this);g.onerror=function(){};g.upload.onprogress=function(e){};g.setRequestHeader('Content-Type',d.type);g.setRequestHeader('x-amz-acl','public-read');g.send(d)}}}},utils:function(){return{isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent)},isString:function(a){return Object.prototype.toString.call(a)=='[object String]'},isEmpty:function(a,b){a=a.replace(/[\u200B-\u200D\uFEFF]/g,'');a=a.replace(/&nbsp;/gi,'');a=a.replace(/<\/?br\s?\/?>/g,'');a=a.replace(/\s/g,'');a=a.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,'');a=a.replace(/<iframe(.*?[^>])>$/i,'iframe');a=a.replace(/<source(.*?[^>])>$/i,'source');if(b!==false){a=a.replace(/<[^\/>][^>]*><\/[^>]+>/gi,'');a=a.replace(/<[^\/>][^>]*><\/[^>]+>/gi,'')}a=$.trim(a);return a===''},normalize:function(a){if(typeof(a)==='undefined')return 0;return parseInt(a.replace('px',''),10)},hexToRgb:function(a){if(typeof a=='undefined')return;if(a.search(/^#/)==-1)return a;var c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(c,function(m,r,g,b){return r+r+g+g+b+b});var d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return'rgb('+parseInt(d[1],16)+', '+parseInt(d[2],16)+', '+parseInt(d[3],16)+')'},getOuterHtml:function(a){return $('<div>').append($(a).eq(0).clone()).html()},getAlignmentElement:function(a){if($.inArray(a.tagName,this.opts.alignmentTags)!==-1){return $(a)}else{return $(a).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}},removeEmptyAttr:function(a,b){var c=$(a);if(typeof c.attr(b)=='undefined'){return true}if(c.attr(b)===''){c.removeAttr(b);return true}return false},removeEmpty:function(i,s){var a=$($.parseHTML(s));a.find('.redactor-invisible-space').removeAttr('style').removeAttr('class');if(a.find('hr, br, img, iframe, source').length!==0)return;var b=$.trim(a.text());if(this.utils.isEmpty(b,false)){a.remove()}},saveScroll:function(){this.saveEditorScroll=this.$editor.scrollTop();this.saveBodyScroll=$(window).scrollTop();if(this.opts.scrollTarget)this.saveTargetScroll=$(this.opts.scrollTarget).scrollTop()},restoreScroll:function(){if(typeof this.saveScroll==='undefined'&&typeof this.saveBodyScroll==='undefined')return;$(window).scrollTop(this.saveBodyScroll);this.$editor.scrollTop(this.saveEditorScroll);if(this.opts.scrollTarget)$(this.opts.scrollTarget).scrollTop(this.saveTargetScroll)},createSpaceElement:function(){var a=document.createElement('span');a.className='redactor-invisible-space';a.innerHTML=this.opts.invisibleSpace;return a},removeInlineTags:function(a){var b=this.opts.inlineTags;b.push('span');if(a.tagName=='PRE')b.push('a');$(a).find(b.join(',')).not('span.redactor-selection-marker').contents().unwrap()},replaceWithContents:function(a,b){var c=this;$(a).replaceWith(function(){if(b===true)c.utils.removeInlineTags(this);return $(this).contents()});return $(a)},replaceToTag:function(a,b,c){var d;var e=this;$(a).replaceWith(function(){d=$('<'+b+' />').append($(this).contents());for(var i=0;i<this.attributes.length;i++){d.attr(this.attributes[i].name,this.attributes[i].value)}if(c===true)e.utils.removeInlineTags(d);return d});return d},isStartOfElement:function(){var a=this.selection.getBlock();if(!a)return false;var b=this.caret.getOffsetOfElement(a);return(b===0)?true:false},isEndOfElement:function(a){if(typeof a=='undefined'){var a=this.selection.getBlock();if(!a)return false}var b=this.caret.getOffsetOfElement(a);var c=$.trim($(a).text()).replace(/\n\r\n/g,'');return(b==c.length)?true:false},isStartOfEditor:function(){var a=this.caret.getOffsetOfElement(this.$editor[0]);return(a===0)?true:false},isEndOfEditor:function(){var a=this.$editor[0];var b=this.caret.getOffsetOfElement(a);var c=$.trim($(a).html().replace(/(<([^>]+)>)/gi,''));return(b==c.length)?true:false},isBlock:function(a){a=a[0]||a;return a&&this.utils.isBlockTag(a.tagName)},isBlockTag:function(a){if(typeof a=='undefined')return false;return this.reIsBlock.test(a)},isTag:function(a,b){var c=$(a).closest(b,this.$editor[0]);if(c.length==1){return c[0]}return false},isSelectAll:function(){return this.selectAll},enableSelectAll:function(){this.selectAll=true},disableSelectAll:function(){this.selectAll=false},isRedactorParent:function(a){if(!a){return false}if($(a).parents('.redactor-editor').length===0||$(a).hasClass('redactor-editor')){return false}return a},isCurrentOrParentHeader:function(){return this.utils.isCurrentOrParent(['H1','H2','H3','H4','H5','H6'])},isCurrentOrParent:function(a){var b=this.selection.getParent();var c=this.selection.getCurrent();if($.isArray(a)){var d=0;$.each(a,$.proxy(function(i,s){if(this.utils.isCurrentOrParentOne(c,b,s)){d++}},this));return(d===0)?false:true}else{return this.utils.isCurrentOrParentOne(c,b,a)}},isCurrentOrParentOne:function(a,b,c){c=c.toUpperCase();return b&&b.tagName===c?b:a&&a.tagName===c?a:false},isOldIe:function(){return(this.utils.browser('msie')&&parseInt(this.utils.browser('version'),10)<9)?true:false},isLessIe10:function(){return(this.utils.browser('msie')&&parseInt(this.utils.browser('version'),10)<10)?true:false},isIe11:function(){return!!navigator.userAgent.match(/Trident\/7\./)},browser:function(a){var b=navigator.userAgent.toLowerCase();var c=/(opr)[\/]([\w.]+)/.exec(b)||/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||b.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(b)||b.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];if(a=='safari')return(typeof c[3]!='undefined')?c[3]=='safari':false;if(a=='version')return c[2];if(a=='webkit')return(c[1]=='chrome'||c[1]=='opr'||c[1]=='webkit');if(c[1]=='rv')return a=='msie';if(c[1]=='opr')return a=='webkit';return a==c[1]},strpos:function(a,b,c){var i=a.indexOf(b,c);return i>=0?i:false},disableBodyScroll:function(){var a=$('html');var b=window.innerWidth;if(!b){var c=document.documentElement.getBoundingClientRect();b=c.right-Math.abs(c.left)}var d=document.body.clientWidth<b;var e=this.utils.measureScrollbar();a.css('overflow','hidden');if(d)a.css('padding-right',e)},measureScrollbar:function(){var a=$('body');var b=document.createElement('div');b.className='redactor-scrollbar-measure';a.append(b);var c=b.offsetWidth-b.clientWidth;a[0].removeChild(b);return c},enableBodyScroll:function(){$('html').css({'overflow':'','padding-right':''});$('body').remove('redactor-scrollbar-measure')}}}};$(window).on('load.tools.redactor',function(){$('[data-tools="redactor"]').redactor()});Redactor.prototype.init.prototype=Redactor.prototype})(jQuery);